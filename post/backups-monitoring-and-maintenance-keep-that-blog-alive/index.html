<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Backups, monitoring and maintenance. Keep that blog alive! - Dave's DevOps blog</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Dave">
<meta name=description content="Our demo WordPress site (part 1 &amp;amp; part 2) is now hosting publicly available content (This page for example). You have written a number of posts, have a few in draft and finally found a theme you liked. What next? Lets discuss backup, swapfile, snapshots, monitoring and certificates.
Backup Last thing you want is to have thrown your heart and sole into a number of posts only for the EC2 instance to crash and you lose all that work.">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.0">
<link rel=canonical href=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/>
<link rel=icon href=/davehart.co.uk/favicon.ico>
<link rel=stylesheet href=/davehart.co.uk/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css integrity="sha256-+ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Backups, monitoring and maintenance. Keep that blog alive!">
<meta property="og:description" content="Our demo WordPress site (part 1 & part 2) is now hosting publicly available content (This page for example). You have written a number of posts, have a few in draft and finally found a theme you liked. What next? Lets discuss backup, swapfile, snapshots, monitoring and certificates.
Backup Last thing you want is to have thrown your heart and sole into a number of posts only for the EC2 instance to crash and you lose all that work.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-10-06T08:08:11+00:00">
<meta property="article:modified_time" content="2020-10-06T08:08:11+00:00">
<meta itemprop=name content="Backups, monitoring and maintenance. Keep that blog alive!">
<meta itemprop=description content="Our demo WordPress site (part 1 & part 2) is now hosting publicly available content (This page for example). You have written a number of posts, have a few in draft and finally found a theme you liked. What next? Lets discuss backup, swapfile, snapshots, monitoring and certificates.
Backup Last thing you want is to have thrown your heart and sole into a number of posts only for the EC2 instance to crash and you lose all that work."><meta itemprop=datePublished content="2020-10-06T08:08:11+00:00">
<meta itemprop=dateModified content="2020-10-06T08:08:11+00:00">
<meta itemprop=wordCount content="2668">
<meta itemprop=keywords content="AWS,AWS,backup,Blog,certbot,cli,dlm,ebs,healthcheck,lsblk,MYSQL,PowerShell,route53,snapshot,sns,ssl,swapfile,WordPress,WordPress,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Backups, monitoring and maintenance. Keep that blog alive!">
<meta name=twitter:description content="Our demo WordPress site (part 1 & part 2) is now hosting publicly available content (This page for example). You have written a number of posts, have a few in draft and finally found a theme you liked. What next? Lets discuss backup, swapfile, snapshots, monitoring and certificates.
Backup Last thing you want is to have thrown your heart and sole into a number of posts only for the EC2 instance to crash and you lose all that work."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/davehart.co.uk/ class=logo>Dave's blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/>Home</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/post/>Posts</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/tags/>Tags</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/about/about/>About</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/davehart.co.uk/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/davehart.co.uk/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/davehart.co.uk/ class=logo>
Dave's blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/>Home</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/post/>Posts</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/tags/>Tags</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://daveihart.github.io/davehart.co.uk/about/about/>About</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Backups, monitoring and maintenance. Keep that blog alive!</h1>
<div class=post-meta>
<time datetime=2020-10-06 class=post-time>
2020-10-06
</time>
<span class=more-meta> 2668 words </span>
<span class=more-meta> 13 min read </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>Table of Contents</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#backup>Backup</a>
<ul>
<li><a href=#wp-backup>WP Backup</a></li>
<li><a href=#snapshot>Snapshot</a></li>
</ul>
</li>
<li><a href=#sizing>Sizing</a></li>
<li><a href=#certificate-renewals>Certificate renewals</a></li>
<li><a href=#aws-route-53-healthcheck>AWS Route 53 Healthcheck</a></li>
<li><a href=#swapfile>Swapfile</a></li>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p>Our demo WordPress site (<a href=/post/terraform-aws-and-wordpress/>part 1</a> & <a href=/post/terraform-aws-and-wordpress-part-ii/>part 2</a>) is now hosting publicly available content (This page for example). You have written a number of posts, have a few in draft and finally found a theme you liked. What next? Lets discuss backup, swapfile, snapshots, monitoring and certificates.</p>
<h2 id=backup>Backup</h2>
<p>Last thing you want is to have thrown your heart and sole into a number of posts only for the EC2 instance to crash and you lose all that work. There are many ways to ensure you have backups of your EC2 instance and/or data. I have put two options below which your could choose one or the other or like me, use both.</p>
<h3 id=wp-backup>WP Backup</h3>
<p>If you dig around the multitude of plugins available for WordPress you should be able to spot a few relating to backup. They all have differing capabilities and options. I was looking for something that could backup the website and SQL and then dump these off server somewhere. Cost was also a factor.</p>
<p>I came across <strong>BackWPup</strong> which allowed me to do these very things and I only needed to spend any money if I wanted push button recovery. I have no SLA, RTO or RPO so thought I would try the free version first. Works great, backups are being dumped to an S3 bucket and I have attempted a test restore of mysql on a test database which was pretty painless.</p>
<h3 id=snapshot>Snapshot</h3>
<p>As well as using the WordPress plugin I decided to keep snapshots in AWS. The rate of change on the instance will be minor so figured the snapshot will allow a pretty painless recovery. Worst case I compliment the snapshot with either the SQL or file backups from the plugin. AWS provide a snapshot lifecycle management capability which I will be using.</p>
<figure style="padding:.25rem;margin:2rem 0;background-color:#fff">
<img style=max-width:100%;width:auto;height:auto src=/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/info_hu90bf0207219454fdfafbb9c93dc105ef_65820_100x0_resize_q75_box.jpg width=100 height=100>
</figure>
<p><strong><em>The majority of activities performed in the article can be performed using the AWS Console. I was once given a great suggestion to try and do everything from the command line interface (CLI). I have found you learn more this way so where possible this is the method I will use.</em></strong></p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image3.png>
</figure>
<p>Within Lifecycle Management my preference was to define a snapshot every 24 hrs from 23:00. I will be retaining 14 days worth of snapshots.</p>
<p>You can use a json input file for your lifecycle policy, this is the one I used.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
	<span class=nt>&#34;ResourceTypes&#34;</span><span class=p>:</span> <span class=p>[</span>
		<span class=s2>&#34;VOLUME&#34;</span>
	<span class=p>],</span>
	<span class=nt>&#34;TargetTags&#34;</span><span class=p>:</span> <span class=p>[{</span>
		<span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;Name&#34;</span><span class=p>,</span>
		<span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;demo&#34;</span>
	<span class=p>}],</span>
	<span class=nt>&#34;Schedules&#34;</span><span class=p>:</span> <span class=p>[{</span>
			<span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;NightlySnapshots&#34;</span><span class=p>,</span>
			<span class=nt>&#34;TagsToAdd&#34;</span><span class=p>:</span> <span class=p>[{</span>
				<span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;type&#34;</span><span class=p>,</span>
				<span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;NightlySnapshot&#34;</span>
			<span class=p>}],</span>
			<span class=nt>&#34;CreateRule&#34;</span><span class=p>:</span> <span class=p>{</span>
				<span class=nt>&#34;Interval&#34;</span><span class=p>:</span> <span class=mi>24</span><span class=p>,</span>
				<span class=nt>&#34;IntervalUnit&#34;</span><span class=p>:</span> <span class=s2>&#34;HOURS&#34;</span><span class=p>,</span>
				<span class=nt>&#34;Times&#34;</span><span class=p>:</span> <span class=p>[</span>
					<span class=s2>&#34;23:00&#34;</span>
				<span class=p>]</span>
			<span class=p>},</span>
			<span class=nt>&#34;RetainRule&#34;</span><span class=p>:</span> <span class=p>{</span>
				<span class=nt>&#34;Count&#34;</span><span class=p>:</span> <span class=mi>14</span>
			<span class=p>},</span>
			<span class=nt>&#34;CopyTags&#34;</span><span class=p>:</span> <span class=kc>true</span>
		<span class=p>}</span>
	<span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div>
<figure style="padding:.25rem;margin:2rem 0;background-color:#fff">
<img style=max-width:100%;width:auto;height:auto src=/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/info_hu90bf0207219454fdfafbb9c93dc105ef_65820_100x0_resize_q75_box.jpg width=100 height=100>
</figure>
<p><strong><em>The default role &ldquo;AWSDataLifecycleManagerServiceRole&rdquo; will be created for AWS to manage the snapshots for you. If you have more restrictive requirements you can create your own role. Note that the person executing this CLI will also need dlm permissions.</em></strong></p>
<p>So lets run the dlm command to create the policy reading in the json file</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>PS </span><span class=n>C:</span><span class=p>\\</span><span class=n>Users</span><span class=p>&gt;</span> <span class=n>aws</span> <span class=n>dlm</span> <span class=nb>create-lifecycle</span><span class=n>-policy</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-description</span> <span class=s2>&#34;Demo Nightly policy&#34;</span> <span class=p>-</span><span class=n>-state</span> <span class=n>ENABLED</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-execution-role-arn</span> <span class=n>arn</span><span class=err>:</span><span class=n>aws</span><span class=err>:</span><span class=n>iam</span><span class=p>::</span><span class=n>SuperSecretAccountNumber</span><span class=err>:</span><span class=n>role</span><span class=p>/</span><span class=n>AWSDataLifecycleManagerDefaultRole</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-policy-details</span> <span class=n>file</span><span class=err>:</span><span class=p>//</span><span class=n>demo_policy</span><span class=p>.</span><span class=n>json</span>                                                                                                                                  <span class=p>{</span>
    <span class=s2>&#34;PolicyId&#34;</span><span class=err>:</span> <span class=s2>&#34;policy-04f757f5f684c1651&#34;</span>
<span class=p>}</span>

<span class=nb>PS </span><span class=n>C:</span><span class=p>\\</span><span class=n>Users</span><span class=p>&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>We know we have been successful as we have been provided with a PolicyId. Lets take a quick look in the console to check.</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-19_hu3c00e47c1cbc521bbf263301dc62876d_44392_480x0_resize_box_3.png 480w,
https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-19_hu3c00e47c1cbc521bbf263301dc62876d_44392_800x0_resize_box_3.png 800w," src=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-19_hu3c00e47c1cbc521bbf263301dc62876d_44392_800x0_resize_box_3.png>
</figure>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-22_hu75fa21777d5ebe50e3d2ca8b60a93867_40206_480x0_resize_box_3.png 480w,
https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-22_hu75fa21777d5ebe50e3d2ca8b60a93867_40206_800x0_resize_box_3.png 800w," src=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-22_hu75fa21777d5ebe50e3d2ca8b60a93867_40206_800x0_resize_box_3.png>
</figure>
<h2 id=sizing>Sizing</h2>
<p>The terraform deployment was configured to use a t2-micro EC2 instance type. This only gives us 1vCPU, 1GB memory and an 8GB root volume. This is pretty small but I thought I would see how it goes.</p>
<p>So far the only concern was the volume size so I pushed this up to 100GB</p>
<p>First you need to expand the volume in the console or using the Command Line Interface (CLI).</p>
<p>Breakdown of the steps below;</p>
<ol>
<li>Retrieve the volume id and size using the instance Name tag (demo in this case)</li>
<li>Expand the volume using the volume id you just retrieved</li>
<li>Check its worked</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>PS </span><span class=n>C:</span><span class=p>\\</span><span class=n>Users</span><span class=p>&gt;</span> <span class=n>aws</span> <span class=n>ec2</span> <span class=nb>describe-volumes</span> <span class=p>/</span>
 <span class=p>-</span><span class=n>-filters</span> <span class=n>Name</span><span class=p>=</span><span class=n>tag</span><span class=err>:</span><span class=n>Name</span><span class=p>,</span><span class=n>Values</span><span class=p>=</span><span class=n>demo</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;Volumes[*].{VolumeID:VolumeId,Size:Size}&#34;</span>                                                        <span class=p>\[</span>
    <span class=p>{</span>
        <span class=s2>&#34;VolumeID&#34;</span><span class=err>:</span> <span class=s2>&#34;vol-0875ae353889ac1a3&#34;</span><span class=p>,</span>
        <span class=s2>&#34;Size&#34;</span><span class=err>:</span> <span class=n>8</span>
    <span class=p>}</span>
 <span class=p>]</span>

<span class=nb>PS </span><span class=n>C:</span><span class=p>\\</span><span class=n>Users</span><span class=p>&gt;</span> <span class=n>aws</span> <span class=n>ec2</span> <span class=nb>modify-volume</span> <span class=p>-</span><span class=n>-size</span> <span class=n>100</span> <span class=p>-</span><span class=n>-volume-id</span> <span class=n>vol</span><span class=p>-</span><span class=n>0875ae353889ac1a3</span>                                                                                                     <span class=p>{</span>
    <span class=s2>&#34;VolumeModification&#34;</span><span class=err>:</span> <span class=p>{</span>
        <span class=s2>&#34;VolumeId&#34;</span><span class=err>:</span> <span class=s2>&#34;vol-0875ae353889ac1a3&#34;</span><span class=p>,</span>
        <span class=s2>&#34;ModificationState&#34;</span><span class=err>:</span> <span class=s2>&#34;modifying&#34;</span><span class=p>,</span>
        <span class=s2>&#34;TargetSize&#34;</span><span class=err>:</span> <span class=n>100</span><span class=p>,</span>
        <span class=s2>&#34;TargetIops&#34;</span><span class=err>:</span> <span class=n>300</span><span class=p>,</span>
        <span class=s2>&#34;TargetVolumeType&#34;</span><span class=err>:</span> <span class=s2>&#34;gp2&#34;</span><span class=p>,</span>
        <span class=s2>&#34;OriginalSize&#34;</span><span class=err>:</span> <span class=n>8</span><span class=p>,</span>
        <span class=s2>&#34;OriginalIops&#34;</span><span class=err>:</span> <span class=n>100</span><span class=p>,</span>
        <span class=s2>&#34;OriginalVolumeType&#34;</span><span class=err>:</span> <span class=s2>&#34;gp2&#34;</span><span class=p>,</span>
        <span class=s2>&#34;Progress&#34;</span><span class=err>:</span> <span class=n>0</span><span class=p>,</span>
        <span class=s2>&#34;StartTime&#34;</span><span class=err>:</span> <span class=s2>&#34;2020-10-05T08:57:52+00:00&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=nb>PS </span><span class=n>C:</span><span class=p>\\</span><span class=n>Users</span><span class=p>&gt;</span> <span class=n>aws</span> <span class=n>ec2</span> <span class=nb>describe-volumes</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-filters</span> <span class=n>Name</span><span class=p>=</span><span class=n>tag</span><span class=err>:</span><span class=n>Name</span><span class=p>,</span><span class=n>Values</span><span class=p>=</span><span class=n>demo</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;Volumes[*].{VolumeID:VolumeId,Size:Size}&#34;</span>                                                        <span class=p>\[</span>
    <span class=p>{</span>
        <span class=s2>&#34;VolumeID&#34;</span><span class=err>:</span> <span class=s2>&#34;vol-0875ae353889ac1a3&#34;</span><span class=p>,</span>
        <span class=s2>&#34;Size&#34;</span><span class=err>:</span> <span class=n>100</span>
    <span class=p>}</span>
<span class=p>]</span>

<span class=nb>PS </span><span class=n>C:</span><span class=p>\\</span><span class=n>Users</span><span class=p>&gt;</span>   
</code></pre></td></tr></table>
</div>
</div><p>Now that we have resized the volume, we should extend the file system for the OS to use it.</p>
<p>First let&rsquo;s putty onto the EC2 instance and check the disk setup</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>[</span>ec2-user@ip-10-0-1-9 ~<span class=o>]</span>$ df -hT
Filesystem     Type      Size  Used Avail Use% Mounted on
devtmpfs       devtmpfs  474M     <span class=m>0</span>  474M   0% /dev
tmpfs          tmpfs     492M     <span class=m>0</span>  492M   0% /dev/shm
tmpfs          tmpfs     492M  456K  492M   1% /run
tmpfs          tmpfs     492M     <span class=m>0</span>  492M   0% /sys/fs/cgroup
/dev/xvda1     xfs       8.0G  1.4G  6.7G  17% /
tmpfs          tmpfs      99M     <span class=m>0</span>   99M   0% /run/user/0
tmpfs          tmpfs      99M     <span class=m>0</span>   99M   0% /run/user/1000
<span class=o>[</span>ec2-user@ip-10-0-1-9 ~<span class=o>]</span>$ lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda    202:0    <span class=m>0</span>  100G  <span class=m>0</span> disk
└─xvda1 202:1    <span class=m>0</span>    8G  <span class=m>0</span> part /

</code></pre></td></tr></table>
</div>
</div><p>This is telling us which file systems are in use for each volume. We only have the one volume so the important line for us /dev/xvda1. We then check the block information using lsblk. This is telling us the root volume /dev/xvda has one partition /dev/xvda1. The root is showing as 100G and the partition as 8GB.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>[</span>ec2-user@ip-10-0-1-9 ~<span class=o>]</span>$ sudo growpart /dev/xvda <span class=m>1</span>
CHANGED: <span class=nv>partition</span><span class=o>=</span><span class=m>1</span> <span class=nv>start</span><span class=o>=</span><span class=m>4096</span> old: <span class=nv>size</span><span class=o>=</span><span class=m>16773087</span> <span class=nv>end</span><span class=o>=</span><span class=m>16777183</span> new: <span class=nv>size</span><span class=o>=</span><span class=m>209711071</span> <span class=nv>end</span><span class=o>=</span><span class=m>209715167</span>
<span class=o>[</span>ec2-user@ip-10-0-1-9 ~<span class=o>]</span>$ lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvda    202:0    <span class=m>0</span>  100G  <span class=m>0</span> disk
└─xvda1 202:1    <span class=m>0</span>  100G  <span class=m>0</span> part /
<span class=o>[</span>ec2-user@ip-10-0-1-9 ~<span class=o>]</span>$

</code></pre></td></tr></table>
</div>
</div><p>Pretty simple, we ran a growpart against the volume telling it to grow partition 1. A quick check using lsblk confirms the extension has been successful.</p>
<h2 id=certificate-renewals>Certificate renewals</h2>
<p>Having never used certbot before I was wondering how I would setup auto-renewals. I had a dig around and could see no cron jobs defined. It appeared that for some distro it would add a line to crontab, looks like we need to do this manually.</p>
<p>This is what the crontab (sudo crontab -e) task looks like</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>59 1,13 \* \* \* root certbot-auto renew --no-self-upgrade

</code></pre></td></tr></table>
</div>
</div><p>What does all that mean?</p>
<ul>
<li>59 1,13 * * * : Run the command at 1:59 and 13:59 every day. Twice a day is a recommendation from the certbot developer</li>
<li>root : Run the command as the root user</li>
<li>certbot-auto renew : Certbot will check and update any certificates that are approaching expiration</li>
<li>--no-self-upgrade : Stops certbot from upgrading itself.</li>
</ul>
<p>Save the crontab and then restart the crond service</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>[</span>root@ip-10-0-1-4 etc<span class=o>]</span><span class=c1># crontab -e</span>
no crontab <span class=k>for</span> root - using an empty one
crontab: installing new crontab
<span class=o>[</span>root@ip-10-0-1-4 etc<span class=o>]</span><span class=c1># service crond restart</span>
Stopping crond:                                            <span class=o>[</span>  OK  <span class=o>]</span>
Starting crond:                                            <span class=o>[</span>  OK  <span class=o>]</span>
<span class=o>[</span>root@ip-10-0-1-4 etc<span class=o>]</span><span class=c1># </span>

</code></pre></td></tr></table>
</div>
</div><p>You can perform a dry run to ensure the command is correct.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>[</span>root@ip-10-0-1-4<span class=o>]</span><span class=c1># ./certbot-auto renew --no-self-upgrade --dry-run</span>
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Processing /etc/letsencrypt/renewal/davehart.co.uk.conf
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Cert not due <span class=k>for</span> renewal, but simulating renewal <span class=k>for</span> dry run
Plugins selected: Authenticator apache, Installer apache
Running pre-hook command: httpd -k stop
Renewing an existing certificate
Performing the following challenges:
http-01 challenge <span class=k>for</span> davehart.co.uk
Waiting <span class=k>for</span> verification...
Cleaning up challenges

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
new certificate deployed with reload of apache server<span class=p>;</span> fullchain is
/etc/letsencrypt/live/davehart.co.uk/fullchain.pem
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
** DRY RUN: simulating <span class=s1>&#39;certbot renew&#39;</span> close to cert expiry
**          <span class=o>(</span>The <span class=nb>test</span> certificates below have not been saved.<span class=o>)</span>

Congratulations, all renewals succeeded. The following certs have been renewed:
  /etc/letsencrypt/live/davehart.co.uk/fullchain.pem <span class=o>(</span>success<span class=o>)</span>
** DRY RUN: simulating <span class=s1>&#39;certbot renew&#39;</span> close to cert expiry
**          <span class=o>(</span>The <span class=nb>test</span> certificates above have not been saved.<span class=o>)</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Running post-hook command: httpd -k start
Output from post-hook <span class=nb>command</span> httpd:
httpd <span class=o>(</span>pid 23491<span class=o>)</span> already running


IMPORTANT NOTES:
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.
<span class=o>[</span>root@ip-10-0-1-4<span class=o>]</span><span class=c1>#</span>

</code></pre></td></tr></table>
</div>
</div><p>This all looks promising but I will still have a calendar reminder set closer to the expiration time :)</p>
<h2 id=aws-route-53-healthcheck>AWS Route 53 Healthcheck</h2>
<p>As I am using Route 53 to handle my external DNS needs it would be a good idea to utilise the <a href=https://docs.aws.amazon.com/cli/latest/reference/route53/create-health-check.html>health check</a> capability provided with the service. This can check to ensure a page responds to queries from multiple geographically disperse locations. If a failure threshold is reached it can be configured to notify you via AWS Simple Notification Service (SNS).</p>
<p>Lets first setup the SNS Topic and subscription. For the topic we are retrieving only the TopicArn so we can feed this into the subscription. My configuration is pretty straight forward but lets again make it more interesting and configure it from the CLI.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=c>#create the sns topic</span>
<span class=nv>$topic</span> <span class=p>=</span> <span class=n>aws</span> <span class=n>sns</span> <span class=nb>create-topic</span> <span class=p>-</span><span class=n>-name</span> <span class=s2>&#34;your topic name&#34;</span> <span class=p>-</span><span class=n>-query</span> <span class=s1>&#39;TopicArn&#39;</span> <span class=p>-</span><span class=n>-region</span> <span class=nb>us-east</span><span class=p>-</span><span class=n>1</span>
<span class=c>#create the subscription to the sns topic</span>
<span class=n>aws</span> <span class=n>sns</span> <span class=n>subscribe</span> <span class=p>-</span><span class=n>-topic-arn</span> <span class=nv>$topic</span> <span class=p>-</span><span class=n>-protocol</span> <span class=n>email</span> <span class=p>-</span><span class=n>-notification-endpoint</span> <span class=n>enteremailaddresshere</span> <span class=p>-</span><span class=n>-region</span> <span class=nb>us-east</span><span class=p>-</span><span class=n>1</span>
</code></pre></td></tr></table>
</div>
</div>
<figure style="padding:.25rem;margin:2rem 0;background-color:#fff">
<img style=max-width:100%;width:auto;height:auto src=/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/info_hu90bf0207219454fdfafbb9c93dc105ef_65820_100x0_resize_q75_box.jpg width=100 height=100>
</figure>
<p><strong><em>AWS Route 53 health check service is only available in us-east-1. So if you are alerting on Route53 metrics look for them in us-east-1 and any SNS topics for these alerts will need to be in the same region</em></strong></p>
<p>First off lets setup our json input file we will use when creating the health check (create-health-check.json). Note that the regions relate to the geographic locations AWS will use to test your FQDN. You need a minimum of three.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
	<span class=nt>&#34;FullyQualifiedDomainName&#34;</span><span class=p>:</span> <span class=s2>&#34;davehart.co.uk&#34;</span><span class=p>,</span>
	<span class=nt>&#34;Port&#34;</span><span class=p>:</span> <span class=mi>443</span><span class=p>,</span>
	<span class=nt>&#34;Type&#34;</span><span class=p>:</span> <span class=s2>&#34;HTTPS&#34;</span><span class=p>,</span>
	<span class=nt>&#34;RequestInterval&#34;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
	<span class=nt>&#34;FailureThreshold&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
	<span class=nt>&#34;EnableSNI&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
	<span class=nt>&#34;Regions&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;us-west-1&#34;</span><span class=p>,</span> <span class=s2>&#34;eu-west-1&#34;</span><span class=p>,</span> <span class=s2>&#34;us-east-1&#34;</span><span class=p>]</span>
<span class=p>}</span>


</code></pre></td></tr></table>
</div>
</div><p>Next we create the health check using the create-health-check subcommand</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>&gt;</span> <span class=n>aws</span> <span class=n>route53</span> <span class=nb>create-health</span><span class=n>-check</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-caller-reference</span> <span class=n>demo</span><span class=p>-</span><span class=n>1</span> <span class=p>-</span><span class=n>-health-check-config</span> <span class=n>file</span><span class=err>:</span><span class=p>//</span><span class=nb>create-health</span><span class=n>-check</span><span class=p>.</span><span class=n>json</span>
</code></pre></td></tr></table>
</div>
</div><p>Even with defining a json input file it appears you have to name/tag the health check afterwards! Tags are key. Tag everything!</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>aws</span> <span class=n>route53</span> <span class=nb>change-tags</span><span class=n>-for-resource</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-resource-type</span> <span class=n>healthcheck</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-resource-id</span> <span class=n>41633bb1</span><span class=p>-</span><span class=n>4adc</span><span class=p>-</span><span class=n>4357</span><span class=p>-</span><span class=n>983f</span><span class=p>-</span><span class=n>767191ff3248</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-add-tags</span> <span class=n>Key</span><span class=p>=</span><span class=n>Name</span><span class=p>,</span><span class=n>Value</span><span class=p>=</span><span class=s2>&#34;demo&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>I could not find a way to generate the alarm during the creation of the health check so used the following command feeding in the value from the HealthCheckId key value pair generated by the create-health-check command above.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>aws</span> <span class=n>cloudwatch</span> <span class=nb>put-metric</span><span class=n>-alarm</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-alarm-name</span> <span class=s2>&#34;demo-monitor&#34;</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-alarm-description</span> <span class=s2>&#34;Alarm when website is not responding&#34;</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-metric-name</span> <span class=n>HealthCheckStatus</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-namespace</span> <span class=n>AWS</span><span class=p>/</span><span class=n>Route53</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-statistic</span> <span class=n>Minimum</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-period</span> <span class=n>60</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-comparison-operator</span> <span class=n>LessThanThreshold</span>  <span class=p>/</span>
<span class=p>-</span><span class=n>-dimensions</span> <span class=s2>&#34;Name=HealthCheckId,Value=%HealthCheckId%&#34;</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-evaluation-periods</span> <span class=n>3</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-alarm-actions</span> <span class=k>%</span><span class=n>arnforsnstopic</span><span class=p>%</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-threshold</span> <span class=n>1</span> <span class=p>/</span>
<span class=p>-</span><span class=n>-region</span> <span class=nb>us-east</span><span class=p>-</span><span class=n>1</span>
</code></pre></td></tr></table>
</div>
</div><p>We can pop all that into a single script</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nv>$caller_ref</span> <span class=p>=</span> <span class=s2>&#34;wp-demo&#34;</span>
<span class=nv>$topic_name</span> <span class=p>=</span> <span class=s2>&#34;wp-demo-topic&#34;</span>
<span class=nv>$email_add</span> <span class=p>=</span> <span class=s2>&#34;secretemailaddress&#34;</span>
<span class=nv>$json_loc</span> <span class=p>=</span> <span class=s2>&#34;c:\users\create-health-check.json&#34;</span>
<span class=nv>$health_check_name</span> <span class=p>=</span> <span class=s2>&#34;wp demo health check&#34;</span>
<span class=nv>$alarm_name</span> <span class=p>=</span> <span class=s2>&#34;wp demo alarm monitor&#34;</span>
<span class=nv>$alarm_description</span> <span class=p>=</span> <span class=s2>&#34;wp Alarm when website is not responding&#34;</span>
<span class=c>#create Topic</span>
<span class=nv>$topic</span> <span class=p>=</span> <span class=n>aws</span> <span class=n>sns</span> <span class=nb>create-topic</span> <span class=p>-</span><span class=n>-name</span> <span class=nv>$topic_name</span> <span class=p>-</span><span class=n>-query</span> <span class=s1>&#39;TopicArn&#39;</span> <span class=p>-</span><span class=n>-region</span> <span class=nb>us-east</span><span class=p>-</span><span class=n>1</span>
<span class=c>#create subscription</span>
<span class=n>aws</span> <span class=n>sns</span> <span class=n>subscribe</span> <span class=p>-</span><span class=n>-topic-arn</span> <span class=nv>$topic</span> <span class=p>-</span><span class=n>-protocol</span> <span class=n>email</span> <span class=p>-</span><span class=n>-notification-endpoint</span> <span class=nv>$email_add</span> <span class=p>-</span><span class=n>-region</span> <span class=nb>us-east</span><span class=p>-</span><span class=n>1</span>
<span class=c>#Create the health check retrieving the id</span>
<span class=nv>$healthyid</span> <span class=p>=</span> <span class=n>aws</span> <span class=n>route53</span> <span class=nb>create-health</span><span class=n>-check</span> <span class=p>-</span><span class=n>-caller-reference</span> <span class=nv>$caller_ref</span> <span class=p>-</span><span class=n>-health-check-config</span> <span class=n>file</span><span class=err>:</span><span class=p>//</span><span class=nv>$json_loc</span> <span class=p>-</span><span class=n>-query</span> <span class=s1>&#39;HealthCheck.Id&#39;</span>
<span class=n>aws</span> <span class=n>route53</span> <span class=nb>change-tags</span><span class=n>-for-resource</span> <span class=p>-</span><span class=n>-resource-type</span> <span class=n>healthcheck</span> <span class=p>-</span><span class=n>-resource-id</span> <span class=nv>$healthyid</span> <span class=p>-</span><span class=n>-add-tags</span> <span class=n>Key</span><span class=p>=</span><span class=n>Name</span><span class=p>,</span><span class=n>Value</span><span class=p>=</span><span class=nv>$health_check_name</span>
<span class=n>aws</span> <span class=n>cloudwatch</span> <span class=nb>put-metric</span><span class=n>-alarm</span> <span class=p>-</span><span class=n>-alarm-name</span> <span class=nv>$alarm_name</span> <span class=p>-</span><span class=n>-alarm-description</span> <span class=nv>$alarm_description</span> <span class=p>-</span><span class=n>-metric-name</span> <span class=n>HealthCheckStatus</span> <span class=p>-</span><span class=n>-namespace</span> <span class=n>AWS</span><span class=p>/</span><span class=n>Route53</span> <span class=p>-</span><span class=n>-statistic</span> <span class=n>Minimum</span> <span class=p>-</span><span class=n>-period</span> <span class=n>60</span> <span class=p>-</span><span class=n>-comparison-operator</span> <span class=n>LessThanThreshold</span>  <span class=p>-</span><span class=n>-dimensions</span> <span class=s2>&#34;Name=HealthCheckId,Value=$healthyid&#34;</span> <span class=p>-</span><span class=n>-evaluation-periods</span> <span class=n>3</span> <span class=p>-</span><span class=n>-alarm-actions</span> <span class=nv>$topic</span> <span class=p>-</span><span class=n>-threshold</span> <span class=n>1</span> <span class=p>-</span><span class=n>-region</span> <span class=nb>us-east</span><span class=p>-</span><span class=n>1</span>
</code></pre></td></tr></table>
</div>
</div><p>You will have to confirm the subscription email manually.</p>
<h2 id=swapfile>Swapfile</h2>
<p>Once I had the above health check enables I started to receive health status alerts at certain times. Investigation showed that the mysql process was not running. Checking over the logs I discovered</p>
<p>Out of memory: Kill process 3923 (mysqld). Oh dear!</p>
<p>If you recall, this is a very small EC2 instance (t2.micro) with only 1GB RAM. The first thing I though of was to check for a swap file</p>
<figure style="padding:.25rem;margin:2rem 0;background-color:#fff">
<img style=max-width:100%;width:auto;height:auto src=/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/info_hu90bf0207219454fdfafbb9c93dc105ef_65820_100x0_resize_q75_box.jpg width=100 height=100>
</figure>
<p>A swap file (also known as virtual memory) contains temporary paged contents of RAM. This allows RAM to be used by other processes. In this instance we will be using the EBS volumes to host the swap file.</p>
<p>Using the command &ldquo;free -m&rdquo; it was evident there was no swap file. Figured this would be the first step in troubleshooting this issue without throwing more RAM at the EC2 instance.</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-32_hu8856654507342d50e48f1832f1be74e4_22005_480x0_resize_box_3.png 480w,
https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-32_hu8856654507342d50e48f1832f1be74e4_22005_800x0_resize_box_3.png 800w," src=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-32_hu8856654507342d50e48f1832f1be74e4_22005_800x0_resize_box_3.png>
</figure>
<p>The recommendation from AWS</p>
<p>As a general rule, calculate swap space according to the following:</p>
<table>
<thead>
<tr>
<th><strong>Amount of physical RAM</strong></th>
<th><strong>Recommended swap space</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>2 GB of RAM or less</td>
<td>2x the amount of RAM but never less than 32 MB</td>
</tr>
<tr>
<td>More than 2 GB of RAM but less than 32 GB</td>
<td>4 GB + (RAM – 2 GB)</td>
</tr>
<tr>
<td>32 GB of RAM or more</td>
<td>1x the amount of RAM</td>
</tr>
</tbody>
</table>
<p>We fell into the first category. The steps for creating the swap file on an Amazon Linux EC2 instance are listed below</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># dd command creates the swap file</span>
<span class=c1># bs = block size and count = number of blocks</span>
sudo dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>/swapfile <span class=nv>bs</span><span class=o>=</span>64M <span class=nv>count</span><span class=o>=</span><span class=m>32</span>
<span class=c1># ensure the permissions are correct for the swap file you just created</span>
sudo chmod <span class=m>600</span> /swapfile
<span class=c1>#tell linux where the swap file is you created</span>
sudo mkswap /swapfile
<span class=c1>#tell linux to use the swap file is you created</span>
sudo swapon /swapfile
<span class=c1>#check it is working</span>
sudo swapon -s
</code></pre></td></tr></table>
</div>
</div>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-42_hucc33a163b83bb31c9479bf08aedb268c_76771_480x0_resize_box_3.png 480w,
https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-42_hucc33a163b83bb31c9479bf08aedb268c_76771_800x0_resize_box_3.png 800w," src=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-42_hucc33a163b83bb31c9479bf08aedb268c_76771_800x0_resize_box_3.png>
</figure>
<p>Once the above steps are complete you need to update the fstab to ensure the swap file is enabled at boot</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1>#edit the fstab</span>
sudo vi /etc/fstab
</code></pre></td></tr></table>
</div>
</div><p>Add the following line to the bottom of the fstab</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>/swapfile swap swap defaults <span class=m>0</span> <span class=m>0</span>
</code></pre></td></tr></table>
</div>
</div>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-300_hu69fc01508033a278b9e48e84f4e3a6c4_13430_480x0_resize_box_3.png 480w," src=https://daveihart.github.io/davehart.co.uk/post/backups-monitoring-and-maintenance-keep-that-blog-alive/image-300.png>
</figure>
<h2 id=conclusion>Conclusion</h2>
<p>So far so good. Server has been up for a good few weeks with no issues. I will update this page if any further updates are required.</p>
<p>Thanks for hanging in there.</p>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://daveihart.github.io/davehart.co.uk/tags/aws/>AWS</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/aws/>AWS</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/backup/>backup</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/blog/>Blog</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/certbot/>certbot</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/cli/>cli</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/dlm/>dlm</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/ebs/>ebs</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/healthcheck/>healthcheck</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/lsblk/>lsblk</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/mysql/>MYSQL</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/powershell/>PowerShell</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/route53/>route53</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/snapshot/>snapshot</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/sns/>sns</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/ssl/>ssl</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/swapfile/>swapfile</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/wordpress/>WordPress</a>
<a href=https://daveihart.github.io/davehart.co.uk/tags/wordpress/>WordPress</a>
</div>
<nav class=post-nav>
<a class=prev href=/davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Encrypting EBS volumes programmatically with python</span>
<span class="prev-text nav-mobile">Prev</span>
</a>
<a class=next href=/davehart.co.uk/post/ec2-inventory-using-aws-lambda-and-python/>
<span class="next-text nav-default">EC2 inventory using AWS Lambda and Python</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=http://localhost:1313 rel="me noopener" class=iconfont title=twitter target=_blank><svg class="icon" viewBox="0 0 1264 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M1229.8616 18.043658s-117.852626 63.135335-164.151872 67.344358C960.484169-78.763856 560.627046-7.210476 627.971403 308.466201 278.622548 312.675223 89.216542 47.506814 89.216542 47.506814S-28.636084 236.91282 164.978944 392.646647C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042 50.5082679999998-16.83609 134.688715-143.10676 134.688715-143.10676s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"/></svg>
</a>
<a href=http://localhost:1313 rel="me noopener" class=iconfont title=linkedin target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="33" height="33"><path d="M872.405333 872.618667H720.768V635.008c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333.0-91.136 61.653333-91.136 125.397334v241.792H398.976V384H544.64v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667.0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667.0 01-88.021333-88.106666A88.064 88.064.0 11227.712 317.141333zm76.032 555.477334H151.68V384h152.064v488.618667zM948.266667.0h-872.704C33.792.0.0 33.024.0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667.0 948.138667.0h.128z"/></svg>
</a>
<a href=http://localhost:1313 rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a>
<a href=https://daveihart.github.io/davehart.co.uk/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2020 -
2021
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Dave
</span></span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/davehart.co.uk/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/davehart.co.uk/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/davehart.co.uk/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript src=/davehart.co.uk/js/load-photoswipe.js></script>
<script type=text/javascript src=/davehart.co.uk/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/davehart.co.uk/lib/photoswipe/photoswipe-ui-default.min.js></script>
</body>
</html>