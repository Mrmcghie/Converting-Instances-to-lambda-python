<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>First! Terraform, AWS and WordPress - Part I - Dave's DevOps blog</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Dave">
<meta name=description content="Well here we go then, where to start? It seemed only fitting that the first post covers the fun I had setting up this WordPress server and site. I looked around at some of the options available, payed hosting etc and decided that &amp;ldquo;hey, lets learn something and share the experience at the same time&amp;rdquo;. Rather than manually setting up and configure the server (easy), I decided to try automate it as much as possible.">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.0">
<link rel=canonical href=https://davehart.co.uk/post/terraform-aws-wordpress/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css integrity="sha256-+ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media=screen crossorigin=anonymous>
<meta property="og:title" content="First!  Terraform, AWS and WordPress - Part I">
<meta property="og:description" content="Well here we go then, where to start? It seemed only fitting that the first post covers the fun I had setting up this WordPress server and site. I looked around at some of the options available, payed hosting etc and decided that &ldquo;hey, lets learn something and share the experience at the same time&rdquo;. Rather than manually setting up and configure the server (easy), I decided to try automate it as much as possible.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://davehart.co.uk/post/terraform-aws-wordpress/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-09-19T02:59:40+00:00">
<meta property="article:modified_time" content="2020-09-19T02:59:40+00:00">
<meta itemprop=name content="First!  Terraform, AWS and WordPress - Part I">
<meta itemprop=description content="Well here we go then, where to start? It seemed only fitting that the first post covers the fun I had setting up this WordPress server and site. I looked around at some of the options available, payed hosting etc and decided that &ldquo;hey, lets learn something and share the experience at the same time&rdquo;. Rather than manually setting up and configure the server (easy), I decided to try automate it as much as possible."><meta itemprop=datePublished content="2020-09-19T02:59:40+00:00">
<meta itemprop=dateModified content="2020-09-19T02:59:40+00:00">
<meta itemprop=wordCount content="2545">
<meta itemprop=keywords content="apache,Apache,AWS,AWS,bash,Blog,HCL,MYSQL,shell,Terraform,Terraform,WordPress,WordPress,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="First!  Terraform, AWS and WordPress - Part I">
<meta name=twitter:description content="Well here we go then, where to start? It seemed only fitting that the first post covers the fun I had setting up this WordPress server and site. I looked around at some of the options available, payed hosting etc and decided that &ldquo;hey, lets learn something and share the experience at the same time&rdquo;. Rather than manually setting up and configure the server (easy), I decided to try automate it as much as possible."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Dave's blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/>Home</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/post/>Posts</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/tags/>Tags</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/about/>About</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Dave's blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/>Home</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/post/>Posts</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/tags/>Tags</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/about/>About</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>First! Terraform, AWS and WordPress - Part I</h1>
<div class=post-meta>
<time datetime=2020-09-19 class=post-time>
2020-09-19
</time>
<span class=more-meta> 2545 words </span>
<span class=more-meta> 12 min read </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>Table of Contents</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#starting-out>Starting out</a></li>
<li><a href=#creating-a-repository>Creating a repository</a></li>
<li><a href=#microsoft-visual-studio-code>Microsoft Visual Studio Code</a></li>
<li><a href=#terraform>Terraform</a></li>
<li><a href=#github--terraform-cloud>GitHub & Terraform cloud</a></li>
<li><a href=#are-we-there-yet>Are we there yet?</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p>Well here we go then, where to start? It seemed only fitting that the first post covers the fun I had setting up this WordPress server and site. I looked around at some of the options available, payed hosting etc and decided that &ldquo;hey, lets learn something and share the experience at the same time&rdquo;. Rather than manually setting up and configure the server (easy), I decided to try automate it as much as possible.</p>
<p>Enter Terraform&mldr;. I started looking at Terraform around 3 months ago and loved it. HCL (HashiCorp Configuration Language) was easy to follow and rather intuitive. As with a lot of technologies I find it best to have a practical use-case to experiment with so I ported my AWS test environment (combination of CF templates and PowerShell) into Terraform. I will discuss this in a separate post but the end result was two Terraform workspaces, one for the network layer and another to stand-up my Jenkins server when it was required. Another factor behind all this was cost saving, I am paying for this myself so If I can provision and destroy easily its win win.</p>
<p>In my quest for complete automation I still need to understand how/if I can use some of the Terraform cloud variables as AWS EC2 user_data values, maybe someone can suggest ideas here ðŸ˜‰</p>
<h2 id=starting-out>Starting out</h2>
<p>I had decided on WordPress as the engine for this blog as it has been around a while now and is still recommended by a lot of people. I wanted the server to be hosted on my AWS account and I wanted to deploy as code. How hard could it be! oh and I wanted to keep costs down.</p>
<p>As my network layer was already in place I jumped straight into the code. Seeing as it should be version controlled and I wanted to leverage the remote execution capabilities of terraform.io my first step was to create a github repository to hold the code.</p>
<h2 id=creating-a-repository>Creating a repository</h2>
<p>I already have an account on GitHub and numerous private repositories so I won&rsquo;t be going into that. Suffice to say it&rsquo;s pretty easy to setup an account.</p>
<p>My repositories all have a naming standard &lt;language/app-usage/location-activity>. In this instances I defined tf-davehart.co.uk-wordpress as the repository name and created it with a blank README.md which will be updated in due course. Pointless having code out there with no description , at my age I will forget what it&rsquo;s for over time!</p>
<ul>
<li>Use the + drop-down menu and select New repository</li>
</ul>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://davehart.co.uk/post/terraform-aws-wordpress/image4.png>
</figure>
<ul>
<li>Give the new repository a memorable name</li>
<li>Add a meaningful description</li>
<li>Make it Public or Private</li>
<li>Initialize this repository with a README</li>
<li>For the sake of this example I also added a .gitignore with a Terraform template. I do not plan on initialising this locally but its just good practice.</li>
<li>Click the big green button</li>
</ul>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-211_hu3a0cda27f345812a38bd39a70b098fda_65452_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-211.png>
</figure>
<p>Once the repository is created, copy the https link from the code dialog;</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-34_huc2c8baea126ce48baf7bc2a6ec6f5e6f_37677_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-34.png>
</figure>
<h2 id=microsoft-visual-studio-code>Microsoft Visual Studio Code</h2>
<p>For development work I use Windows 10 with Microsoft Visual Studio Code. Depending on the use case I will either develop locally or will use a WSL deployment of Ubuntu. For this project I will just stick to local. Next task is to clone the repository we just created on GitHub using git.</p>
<ul>
<li>Navigate to a folder where you want to host your clone of the repository</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>git init
git clone https://github.com/daveihart/tf-davehart.co.uk-wordpress_.git
</code></pre></td></tr></table>
</div>
</div>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-52_huf76db7506b3b962b9415031d178ef3d8_62931_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-52_huf76db7506b3b962b9415031d178ef3d8_62931_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-52_huf76db7506b3b962b9415031d178ef3d8_62931_800x0_resize_box_3.png>
</figure>
<h2 id=terraform>Terraform</h2>
<p>Now there are many ways to setup your Terraform project. I like to separate out the key sections into their own files. For this project I started with three files. You can deploy your HCL all in one file but I like to think of the possibility to expand on a project and it would be easier if you do all the groundwork from the start. This method will also make it easier to trawl through the code in smaller files should you encounter any issues.</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://davehart.co.uk/post/terraform-aws-wordpress/image-61.png>
</figure>
<p>The variables file will hold any variables required for the deployment. Hopefully the optional descriptions added will be enough</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># VARIABLES
</span><span class=c1></span>
<span class=k>variable</span> <span class=s2>&#34;region&#34;</span> {
<span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;AWS region to use when provisioning&#34;</span>
<span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
<span class=n>  default</span>     <span class=o>=</span> <span class=s2>&#34;eu-west-2&#34;</span>
}
<span class=k>variable</span> <span class=s2>&#34;key_name&#34;</span> {
<span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;ec2 instance keypair to use when provisioning&#34;</span>
<span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
<span class=n>  default</span>     <span class=o>=</span> <span class=s2>&#34;supersecretkeypair&#34;</span>
}
<span class=k>variable</span> <span class=s2>&#34;env_prefix&#34;</span> {
<span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;prefix used for tags and the like&#34;</span>
<span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
<span class=n>  default</span>     <span class=o>=</span> <span class=s2>&#34;dev&#34;</span>
}
<span class=k>variable</span> <span class=s2>&#34;instance_size&#34;</span> {
<span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;instance type mapping based on role&#34;</span>
<span class=n>  type</span>        <span class=o>=</span> <span class=k>map</span><span class=p>(</span><span class=k>string</span><span class=p>)</span>
<span class=n>  default</span>     <span class=o>=</span><span class=n> { wordpress</span> <span class=o>=</span> <span class=s2>&#34;t2.micro&#34;</span> }

}
<span class=k>variable</span> <span class=s2>&#34;dns_zone_id&#34;</span> {
<span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;zone id for route 53&#34;</span>
<span class=n>  type</span>        <span class=o>=</span> <span class=k>string</span>
<span class=n>  default</span>     <span class=o>=</span> <span class=s2>&#34;supersecretdnszone&#34;</span>
}
<span class=k>variable</span> <span class=s2>&#34;wordpress_count&#34;</span> {
<span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;number of wordpress servers to deploy&#34;</span>
<span class=n>  type</span>        <span class=o>=</span> <span class=k>number</span>
<span class=n>  default</span>     <span class=o>=</span> <span class=m>1</span>
} 
</code></pre></td></tr></table>
</div>
</div><p>The providers file will only need to hold the AWS provider for this project.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># PROVIDERS
</span><span class=c1></span><span class=k>provider</span> <span class=s2>&#34;aws&#34;</span> {
<span class=n>  region</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>region</span>
}
</code></pre></td></tr></table>
</div>
</div><p>Now here is the big one, the WordPress file. This is where all the good stuff is carried out. I am going to break this down into it&rsquo;s component parts as it will be easier to explain. I will also publish this all as public GitHub repo for others to fork and play around with themselves. Best way to learn!</p>
<p>Lets start&mldr;</p>
<p>The <strong>backend</strong> is used to determine how state is loaded and how the plan and apply are executed. In this example I am using a <strong>remote backend</strong> which is Terraform cloud. My organisation has been defined and a workspace to hold the app state, runs, approvals etc.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># BACKEND
</span><span class=c1></span>
<span class=k>terraform</span> {
  <span class=k>backend</span> <span class=s2>&#34;remote&#34;</span> {
<span class=n>    organization</span> <span class=o>=</span> <span class=s2>&#34;my_organisation&#34;</span>
    <span class=k>workspaces</span> {
<span class=n>      name</span> <span class=o>=</span> <span class=s2>&#34;tf_davehart_wordpress&#34;</span>
    }
  }
}
</code></pre></td></tr></table>
</div>
</div><p>The <strong>data sources</strong> in this deployment are defining which VPC, subnet, and AMI we will be using. When deploying the network I use the same environment code. For example we are using a VPC with the name &ldquo;dev-vpc&rdquo;, the subnet is the &ldquo;dev-public&rdquo; subnet and the ami is the latest aws-linux hvm ami using ebs type volumes.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># DATA Sources
</span><span class=c1></span><span class=k>data</span> <span class=s2>&#34;aws_vpc&#34; &#34;vpc&#34;</span> {
<span class=n>  tags</span> <span class=o>=</span> {
<span class=n>    Name</span> <span class=o>=</span> <span class=s2>&#34;${var.env_prefix}-vpc&#34;</span>
  }
}
<span class=k>data</span> <span class=s2>&#34;aws_subnet&#34; &#34;public&#34;</span> {
<span class=n>  tags</span> <span class=o>=</span> {
<span class=n>    Name</span> <span class=o>=</span> <span class=s2>&#34;${var.env_prefix}-public&#34;</span>
  }
}
<span class=k>data</span> <span class=s2>&#34;aws_ami&#34; &#34;aws-linux&#34;</span> {
<span class=n>  most_recent</span> <span class=o>=</span> <span class=kt>true</span>
<span class=n>  owners</span>      <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;amazon&#34;</span><span class=p>]</span>
  <span class=k>filter</span> {
<span class=n>    name</span>   <span class=o>=</span> <span class=s2>&#34;name&#34;</span>
<span class=n>    values</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;amzn-ami-hvm*&#34;</span><span class=p>]</span>
  }
  <span class=k>filter</span> {
<span class=n>    name</span>   <span class=o>=</span> <span class=s2>&#34;root-device-type&#34;</span>
<span class=n>    values</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;ebs&#34;</span><span class=p>]</span>
  }
  <span class=k>filter</span> {
<span class=n>    name</span>   <span class=o>=</span> <span class=s2>&#34;virtualization-type&#34;</span>
<span class=n>    values</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;hvm&#34;</span><span class=p>]</span>
  }
}
</code></pre></td></tr></table>
</div>
</div><p>Now we start defining our <strong>resources</strong>. First up, security groups.</p>
<p>The table reflects what we are looking to define</p>
<table>
<thead>
<tr>
<th>Direction</th>
<th>protocol</th>
<th>port(s)</th>
<th>cidr</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>ingress</td>
<td>tcp</td>
<td>22</td>
<td>0.0.0.0/0</td>
<td>ssh access</td>
</tr>
<tr>
<td>ingress</td>
<td>tcp</td>
<td>443</td>
<td>0.0.0.0/0</td>
<td>HTTPS/SSL</td>
</tr>
<tr>
<td>ingress</td>
<td>tcp</td>
<td>20-21</td>
<td>0.0.0.0/0</td>
<td>ftp</td>
</tr>
<tr>
<td>ingress</td>
<td>tcp</td>
<td>1024-1048</td>
<td>0.0.0.0/0</td>
<td>ftp</td>
</tr>
<tr>
<td>ingress</td>
<td>tcp</td>
<td>80</td>
<td>0.0.0.0/0</td>
<td>HTTP (used for certbot)</td>
</tr>
<tr>
<td>egress</td>
<td>all</td>
<td>all</td>
<td>0.0.0.0/0</td>
<td></td>
</tr>
</tbody>
</table>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># RESOURCES
</span><span class=c1>
</span><span class=c1># SECURITY GROUPS #
</span><span class=c1># WordPress security group 
</span><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;wordpress-sg&#34;</span> {
<span class=n>  name</span>   <span class=o>=</span> <span class=s2>&#34;${var.env_prefix}_wordpress_sg&#34;</span>
<span class=n>  vpc_id</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>id</span><span class=c1>
</span><span class=c1>  # SSH access from anywhere
</span><span class=c1></span>  <span class=k>ingress</span> {
<span class=n>    from_port</span>   <span class=o>=</span> <span class=m>22</span>
<span class=n>    to_port</span>     <span class=o>=</span> <span class=m>22</span>
<span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
<span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
  }<span class=c1>
</span><span class=c1>
</span><span class=c1>  # HTTPS access
</span><span class=c1></span>  <span class=k>ingress</span> {
<span class=n>    from_port</span>   <span class=o>=</span> <span class=m>443</span>
<span class=n>    to_port</span>     <span class=o>=</span> <span class=m>443</span>
<span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
<span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
  }<span class=c1>
</span><span class=c1>
</span><span class=c1>  # FTP access
</span><span class=c1></span>  <span class=k>ingress</span> {
<span class=n>    from_port</span>   <span class=o>=</span> <span class=m>20</span>
<span class=n>    to_port</span>     <span class=o>=</span> <span class=m>21</span>
<span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
<span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
  }<span class=c1>
</span><span class=c1>
</span><span class=c1>  # FTP access
</span><span class=c1></span>  <span class=k>ingress</span> {
<span class=n>    from_port</span>   <span class=o>=</span> <span class=m>1024</span>
<span class=n>    to_port</span>     <span class=o>=</span> <span class=m>1048</span>
<span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
<span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
  }<span class=c1>
</span><span class=c1>
</span><span class=c1># HTTP access - needed for Certbot
</span><span class=c1></span>  <span class=k>ingress</span> {
<span class=n>    from_port</span>   <span class=o>=</span> <span class=m>80</span>
<span class=n>    to_port</span>     <span class=o>=</span> <span class=m>80</span>
<span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
<span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
  }<span class=c1>
</span><span class=c1>
</span><span class=c1>  # outbound internet access
</span><span class=c1></span>  <span class=k>egress</span> {
<span class=n>    from_port</span>   <span class=o>=</span> <span class=m>0</span>
<span class=n>    to_port</span>     <span class=o>=</span> <span class=m>0</span>
<span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
<span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
  }
} 
</code></pre></td></tr></table>
</div>
</div><p>Next up we define our instance. This is where we attempt to minimise any configuration post deployment by defining a lot of user_data (AWS bootstrap). I will dedicate a separate page to this and drill down into some of the other parts such as certbot and ftp. The eagled eyed will notice the odd password slipping into the user_data lines. This is next on my list of things to remove. I would like to pass these in from Terraform cloud as sensitive environment variables.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># RESOURCES
</span><span class=c1></span><span class=p>...</span><span class=k>Continued</span><span class=c1>
</span><span class=c1># INSTANCES #
</span><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_instance&#34; &#34;wordpress&#34;</span> {
<span class=n>  count</span>                  <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>wordpress_count</span>
<span class=n>  ami</span>                    <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_ami</span><span class=p>.</span><span class=k>aws</span><span class=err>-</span><span class=k>linux</span><span class=p>.</span><span class=k>id</span>
<span class=n>  instance_type</span>          <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>instance_size</span><span class=p>[</span><span class=s2>&#34;wordpress&#34;</span><span class=p>]</span>
<span class=n>  subnet_id</span>              <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnet</span><span class=p>.</span><span class=k>public</span><span class=p>.</span><span class=k>id</span>
<span class=n>  vpc_security_group_ids</span> <span class=o>=</span> <span class=p>[</span><span class=k>aws_security_group</span><span class=p>.</span><span class=k>wordpress</span><span class=err>-</span><span class=k>sg</span><span class=p>.</span><span class=k>id</span><span class=p>]</span>
<span class=n>  key_name</span>               <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>key_name</span>
<span class=n>  tags</span>      <span class=o>=</span><span class=n> merge(local.common_tags, { Name</span> <span class=o>=</span> <span class=s2>&#34;${var.env_prefix}-wordpress&#34;</span> }<span class=p>)</span>
<span class=n>  user_data</span> <span class=o>=</span> <span class=err>&lt;&lt;</span><span class=k>EOF</span><span class=c1>
</span><span class=c1>          #!/bin/bash
</span><span class=c1></span>          <span class=k>sudo</span> <span class=k>yum</span> <span class=k>update</span> <span class=err>-</span><span class=k>y</span>
          <span class=k>sudo</span> <span class=k>yum</span> <span class=k>install</span> <span class=err>-</span><span class=k>y</span> <span class=k>httpd24</span> <span class=k>php72</span> <span class=k>mysql57</span><span class=err>-</span><span class=k>server</span> <span class=k>php72</span><span class=err>-</span><span class=k>mysqlnd</span>
          <span class=k>sudo</span> <span class=k>service</span> <span class=k>mysqld</span> <span class=k>start</span>
          <span class=k>sudo</span> <span class=k>service</span> <span class=k>httpd</span> <span class=k>start</span>
          <span class=k>sudo</span> <span class=k>chkconfig</span> <span class=k>httpd</span> <span class=k>on</span>
          <span class=k>sudo</span> <span class=k>chkconfig</span> <span class=k>mysqld</span> <span class=k>on</span>
          <span class=k>sudo</span> <span class=k>usermod</span> <span class=err>-</span><span class=k>a</span> <span class=err>-</span><span class=k>G</span> <span class=k>apache</span> <span class=k>ec2</span><span class=err>-</span><span class=k>user</span>
          <span class=k>sudo</span> <span class=k>chown</span> <span class=err>-</span><span class=k>R</span> <span class=k>ec2</span><span class=err>-</span><span class=k>user</span><span class=err>:</span><span class=k>apache</span> <span class=err>/</span><span class=k>var</span><span class=err>/</span><span class=k>www</span>
          <span class=k>sudo</span> <span class=k>yum</span> <span class=k>install</span> <span class=err>-</span><span class=k>y</span> <span class=k>mod24_ssl</span>
          <span class=k>sudo</span> <span class=k>yum</span><span class=err>-</span><span class=k>config</span><span class=err>-</span><span class=k>manager</span> <span class=err>--</span><span class=k>enable</span> <span class=k>epel</span>
          <span class=k>sudo</span> <span class=k>wget</span> <span class=k>https</span><span class=err>://</span><span class=k>dl</span><span class=p>.</span><span class=k>eff</span><span class=p>.</span><span class=k>org</span><span class=err>/</span><span class=k>certbot</span><span class=err>-</span><span class=k>auto</span>
          <span class=k>sudo</span> <span class=k>chmod</span> <span class=k>a</span><span class=err>+</span><span class=k>x</span> <span class=k>certbot</span><span class=err>-</span><span class=k>auto</span>
          <span class=k>sudo</span> <span class=k>echo</span> <span class=s2>&#34;&lt;VirtualHost *:80&gt;&#34;</span> <span class=err>&gt;&gt;</span> <span class=err>/</span><span class=k>etc</span><span class=err>/</span><span class=k>httpd</span><span class=err>/</span><span class=k>conf</span><span class=err>/</span><span class=k>httpd</span><span class=p>.</span><span class=k>conf</span>
          <span class=k>sudo</span> <span class=k>echo</span> <span class=s2>&#34;ServerName davehart.co.uk&#34;</span> <span class=err>&gt;&gt;</span> <span class=err>/</span><span class=k>etc</span><span class=err>/</span><span class=k>httpd</span><span class=err>/</span><span class=k>conf</span><span class=err>/</span><span class=k>httpd</span><span class=p>.</span><span class=k>conf</span>
          <span class=k>sudo</span> <span class=k>echo</span> <span class=s2>&#34;DocumentRoot /var/www/html&#34;</span> <span class=err>&gt;&gt;</span> <span class=err>/</span><span class=k>etc</span><span class=err>/</span><span class=k>httpd</span><span class=err>/</span><span class=k>conf</span><span class=err>/</span><span class=k>httpd</span><span class=p>.</span><span class=k>conf</span>
          <span class=k>sudo</span> <span class=k>echo</span> <span class=s2>&#34;&lt;/VirtualHost&gt;&#34;</span> <span class=err>&gt;&gt;</span> <span class=err>/</span><span class=k>etc</span><span class=err>/</span><span class=k>httpd</span><span class=err>/</span><span class=k>conf</span><span class=err>/</span><span class=k>httpd</span><span class=p>.</span><span class=k>conf</span>
          <span class=k>sudo</span> <span class=p>.</span><span class=err>/</span><span class=k>certbot</span><span class=err>-</span><span class=k>auto</span> <span class=err>--</span><span class=k>authenticator</span> <span class=k>apache</span> <span class=err>--</span><span class=k>debug</span> <span class=err>--</span><span class=k>agree</span><span class=err>-</span><span class=k>tos</span> <span class=err>-</span><span class=k>m</span> <span class=s2>&#34;myemailaddress&#34; --installer apache -d &#34;davehart.co.uk&#34; --pre-hook &#34;httpd -k stop&#34; --post-hook &#34;httpd -k start&#34;</span> <span class=err>-</span><span class=k>n</span>
          <span class=k>sudo</span> <span class=k>wget</span> <span class=k>https</span><span class=err>://</span><span class=k>wordpress</span><span class=p>.</span><span class=k>org</span><span class=err>/</span><span class=k>latest</span><span class=p>.</span><span class=k>tar</span><span class=p>.</span><span class=k>gz</span>
          <span class=k>sudo</span> <span class=k>tar</span> <span class=err>-</span><span class=k>xzf</span> <span class=k>latest</span><span class=p>.</span><span class=k>tar</span><span class=p>.</span><span class=k>gz</span>
<span class=n>          mysql -u root -e &#34;delete from mysql.user where user</span><span class=o>=</span><span class=n>&#39;&#39;;drop database if exists test;delete from mysql.db where db</span><span class=o>=</span><span class=n>&#39;test&#39; or db</span><span class=o>=</span><span class=err>&#39;</span><span class=k>test</span><span class=err>\\</span><span class=k>_</span><span class=err>%&#39;;</span><span class=k>flush</span> <span class=k>privileges</span><span class=err>;&#34;</span>
          <span class=k>mysql</span> <span class=err>-</span><span class=k>u</span> <span class=k>root</span> <span class=err>-</span><span class=k>e</span> <span class=s2>&#34;create user &#39;a-user-for-wordpress&#39;@&#39;localhost&#39; identified by &#39;superstrongpassword&#39;;create database wordpressdb;grant all privileges on wordpressdb.* to &#39;a-user-for-wordpress&#39;@&#39;localhost&#39;;FLUSH PRIVILEGES;&#34;</span>
          <span class=k>cp</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=err>-</span><span class=k>sample</span><span class=p>.</span><span class=k>php</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;DB_NAME&#39;, &#39;database_name_here&#39; );/define( &#39;DB_NAME&#39;, &#39;wordpressdb&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;DB_USER&#39;, &#39;username_here&#39; );/define( &#39;DB_USER&#39;, &#39;a-user-for-wordpress&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;DB_PASSWORD&#39;, &#39;password_here&#39; );/define( &#39;DB_PASSWORD&#39;, &#39;superstrongpassword&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;AUTH_KEY&#39;,         &#39;put your unique phrase here&#39; );/define( &#39;AUTH_KEY&#39;,         &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;SECURE_AUTH_KEY&#39;,  &#39;put your unique phrase here&#39; );/define( &#39;SECURE_AUTH_KEY&#39;,  &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;LOGGED_IN_KEY&#39;,    &#39;put your unique phrase here&#39; );/define( &#39;LOGGED_IN_KEY&#39;,    &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;NONCE_KEY&#39;,        &#39;put your unique phrase here&#39; );/define( &#39;NONCE_KEY&#39;,        &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;AUTH_SALT&#39;,        &#39;put your unique phrase here&#39; );/define( &#39;AUTH_SALT&#39;,        &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;SECURE_AUTH_SALT&#39;, &#39;put your unique phrase here&#39; );/define( &#39;SECURE_AUTH_SALT&#39;, &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;LOGGED_IN_SALT&#39;,   &#39;put your unique phrase here&#39; );/define( &#39;LOGGED_IN_SALT&#39;,   &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span>
          <span class=k>sed</span> <span class=err>-</span><span class=k>i</span> <span class=s2>&#34;s/define( &#39;NONCE_SALT&#39;,       &#39;put your unique phrase here&#39; );/define( &#39;NONCE_SALT&#39;,       &#39;uniquesalt&#39; );/g&#34;</span> <span class=err>/</span><span class=k>wordpress</span><span class=err>/</span><span class=k>wp</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>php</span> 
          <span class=k>cp</span> <span class=err>-</span><span class=k>r</span> <span class=k>wordpress</span><span class=cm>/* /var/www/html/
</span><span class=cm>          sed -i &#39;/&lt;Directory &#34;\/var\/www\/html&#34;&gt;/,/&lt;\/Directory&gt;/ s/AllowOverride None/AllowOverride all/&#39; httpd.conf
</span><span class=cm>          sudo yum install php72-gd -y
</span><span class=cm>          sudo service httpd restart
</span><span class=cm>          sudo yum install vsftpd -y
</span><span class=cm>          sed -i &#34;s/anonymous_enable=Yes;/anonymous_enable=No;/g&#34; /etc/vsftpd/vsftpd.conf
</span><span class=cm>          sudo echo &#34;pasv_enable=YES&#34; &gt;&gt; /etc/vsftpd/vsftpd.conf
</span><span class=cm>          sudo echo &#34;pasv_min_port=1024&#34; &gt;&gt; /etc/vsftpd/vsftpd.conf
</span><span class=cm>          sudo echo &#34;pasv_max_port=1048&#34; &gt;&gt; /etc/vsftpd/vsftpd.conf
</span><span class=cm>          sudo echo &#34;pasv_addr_resolve=YES&#34; &gt;&gt; /etc/vsftpd/vsftpd.conf
</span><span class=cm>          sudo echo &#34;pasv_address=davehart.co.uk&#34; &gt;&gt; /etc/vsftpd/vsftpd.conf
</span><span class=cm>          sudo useradd wordpress-user
</span><span class=cm>          sudo echo -e &#34;7111065299081&#34; | passwd wordpress 
</span><span class=cm>          sudo usermod
</span><span class=cm>          sudo chmod 2775 /var/www
</span><span class=cm>          sudo find /var/www -type d -exec sudo chmod 2775 {} \;
</span><span class=cm>          sudo find /var/www -type f -exec sudo chmod 0664 {} \;
</span><span class=cm>    EOF
</span><span class=cm>} 
</span></code></pre></td></tr></table>
</div>
</div><p>Any finally we want our new instance to be associated with a DNS name. I recently registered the davehart.co.uk domain and as I wanted to be able to programmatically update the zone I changed the DNS NS (name Servers) to AWS, first defining the zone in Route 53.</p>
<p>Important point to note, we are defining a record (pointer) for the root (apex) of the domain. In AWS this has to be an A-record unless you are utilising services such as AWS ELB or AWS CloudFront. I might still consume some of the services but for this initial setup the A-Record works for me.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-HCL data-lang=HCL><span class=c1># Route53 #
</span><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_route53_record&#34; &#34;wordpress&#34;</span> {
<span class=n>  zone_id</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>dns_zone_id</span>
<span class=n>  name</span>            <span class=o>=</span> <span class=s2>&#34;.&#34;</span>
<span class=n>  type</span>            <span class=o>=</span> <span class=s2>&#34;A&#34;</span>
<span class=n>  ttl</span>             <span class=o>=</span> <span class=s2>&#34;5&#34;</span>
<span class=n>  records</span>         <span class=o>=</span> <span class=p>[</span><span class=k>aws_instance</span><span class=p>.</span><span class=k>wordpress</span><span class=p>[</span><span class=m>0</span><span class=p>].</span><span class=k>public_ip</span><span class=p>]</span>
<span class=n>  allow_overwrite</span> <span class=o>=</span> <span class=kt>true</span>
} 
</code></pre></td></tr></table>
</div>
</div><p>Before we commit this code I want to setup a workspace on my Terraform cloud and integrate this with the GitHub repository. When we do then push the code to GitHub it will trigger Terraform.</p>
<h2 id=github--terraform-cloud>GitHub & Terraform cloud</h2>
<p>So we have already setup our GitHub repository, lets setup a new workspace on Terraform cloud to organise our infrastructure. I am not going to talk about setting up an account with Terraform cloud, just follow the <a href=https://www.terraform.io/>link</a> and create an account.</p>
<p>Once logged into app.terraform.io, click</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://davehart.co.uk/post/terraform-aws-wordpress/image-71.png>
</figure>
<p>Choose your workflow type, for this I am going to use the version control workspace. Your choice really</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-81_hu3358c8caa0012e2c9eadfab723b871a4_55684_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-81_hu3358c8caa0012e2c9eadfab723b871a4_55684_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-81_hu3358c8caa0012e2c9eadfab723b871a4_55684_800x0_resize_box_3.png>
</figure>
<p>I already have GiHub integrated with Terraform so I can just select that as my VCS. Steps <a href=https://www.terraform.io/docs/cloud/vcs/github-app.html>here</a> if you are interested.</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-100_hua4b635c32c767d988a5e529e8af6ba59_57873_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-100_hua4b635c32c767d988a5e529e8af6ba59_57873_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-100_hua4b635c32c767d988a5e529e8af6ba59_57873_800x0_resize_box_3.png>
</figure>
<p>Once I select GitHub it will list all of my repositories. I have selected the one relating to this project</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-200_hua7a60f9504216142db1ad7a92a7d33d1_20909_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-200.png>
</figure>
<p>Once you select the Workspace you have a few options. Define the workspace name and in advanced options you can define your VCS branch, Terrform working dir, Workspace name, etc.</p>
<p>Click the button</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://davehart.co.uk/post/terraform-aws-wordpress/image-110.png>
</figure>
<p>All goes well you will see a message like this,</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-120_hu33f851549e0eb8a4ce0ed5ee118d3398_12322_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-120.png>
</figure>
<p>closely followed by</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-130_hu6a40f7876e1cd36152538a37da3c8f9d_17137_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-130.png>
</figure>
<p>For this deployment I created two environment variables (secret) to hold my AWS keys. The naming is important for the AWS provider to retrieve the correct values</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-140_hu4d8de3099e5736790dd20a03ff7d4a89_15990_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-140.png>
</figure>
<p>If we now jump back to our repository and look at the webhooks, we should see one for Terraform</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-150_hudcc2870f61e17425feebd955a5d6f0b8_40612_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-150_hudcc2870f61e17425feebd955a5d6f0b8_40612_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-150_hudcc2870f61e17425feebd955a5d6f0b8_40612_800x0_resize_box_3.png>
</figure>
<p>Integration complete.</p>
<h2 id=are-we-there-yet>Are we there yet?</h2>
<p>Now we have our HCL code all ready to go, our GitHub repo is primed to notify Terraform of any code changes, lets get our code commited and pushed to GitHub.</p>
<p>Back to Microsoft Visual Studio Code and in the PowerShell terminal window (You can have VS Code do all this for you but typing the commands helps me remember them :) )</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>git add *.tf
git commit -m <span class=s2>&#34;Initial&#34;</span>
git push
</code></pre></td></tr></table>
</div>
</div>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-160_hu542b9b19faf0e68271ad1dffa554b4f3_36219_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-160.png>
</figure>
<p>Quick refresh on our GitHub repository</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-170_hu4e1f5dd357354ce4a49f0546f0444ae8_40847_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-170_hu4e1f5dd357354ce4a49f0546f0444ae8_40847_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-170_hu4e1f5dd357354ce4a49f0546f0444ae8_40847_800x0_resize_box_3.png>
</figure>
<p>Lets see what is happening over at Terraform&mldr;Nothing. I seem to have to kick off the first plan manually. Press</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://davehart.co.uk/post/terraform-aws-wordpress/image-180.png>
</figure>
<p>Now this deployment gave me</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-190_hudaee5d6a7d4022956c3b9d5195441019_11071_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-190_hudaee5d6a7d4022956c3b9d5195441019_11071_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-190_hudaee5d6a7d4022956c3b9d5195441019_11071_800x0_resize_box_3.png>
</figure>
<p>Good reason, I did not define valid environment variables as I have already deployed this and its where I am now writing this article :)</p>
<p>When all the variables are correct and you have a successful run, you will see</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-210_hucae1380fb83b0ad8e8cb8f802c50bdc6_39219_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/terraform-aws-wordpress/image-210_hucae1380fb83b0ad8e8cb8f802c50bdc6_39219_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-210_hucae1380fb83b0ad8e8cb8f802c50bdc6_39219_800x0_resize_box_3.png>
</figure>
<p>Your Terraform plans and state are all in Terraform cloud. If you want to tear it all down, navigate to settings, destruction and deletion and queue a destroy plan</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/terraform-aws-wordpress/image-220_hu8cec63d4bbb388b38a6ca64511d1eead_14781_480x0_resize_box_3.png 480w," src=https://davehart.co.uk/post/terraform-aws-wordpress/image-220.png>
</figure>
<p>I Hope you find this useful and maybe even considered dropping in again. Please take a look at <a href=/post/terraform-aws-and-wordpress-part-ii/>Part II</a> which will dig into some of the user_data and certbot. Great tool to allow you to automate external certificate registration and deployment.</p>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://davehart.co.uk/tags/apache/>apache</a>
<a href=https://davehart.co.uk/tags/apache/>Apache</a>
<a href=https://davehart.co.uk/tags/aws/>AWS</a>
<a href=https://davehart.co.uk/tags/aws/>AWS</a>
<a href=https://davehart.co.uk/tags/bash/>bash</a>
<a href=https://davehart.co.uk/tags/blog/>Blog</a>
<a href=https://davehart.co.uk/tags/hcl/>HCL</a>
<a href=https://davehart.co.uk/tags/mysql/>MYSQL</a>
<a href=https://davehart.co.uk/tags/shell/>shell</a>
<a href=https://davehart.co.uk/tags/terraform/>Terraform</a>
<a href=https://davehart.co.uk/tags/terraform/>Terraform</a>
<a href=https://davehart.co.uk/tags/wordpress/>WordPress</a>
<a href=https://davehart.co.uk/tags/wordpress/>WordPress</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/terraform-aws-and-wordpress-part-ii/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Terraform, AWS and WordPress â€“ Part II</span>
<span class="prev-text nav-mobile">Prev</span>
</a>
</nav>
</footer>
</article>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=https://twitter.com/daveihart rel="me noopener" class=iconfont title=twitter target=_blank><svg class="icon" viewBox="0 0 1264 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M1229.8616 18.043658s-117.852626 63.135335-164.151872 67.344358C960.484169-78.763856 560.627046-7.210476 627.971403 308.466201 278.622548 312.675223 89.216542 47.506814 89.216542 47.506814S-28.636084 236.91282 164.978944 392.646647C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042 50.5082679999998-16.83609 134.688715-143.10676 134.688715-143.10676s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"/></svg>
</a>
<a href=https://www.linkedin.com/in/dave-hart/ rel="me noopener" class=iconfont title=linkedin target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="33" height="33"><path d="M872.405333 872.618667H720.768V635.008c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333.0-91.136 61.653333-91.136 125.397334v241.792H398.976V384H544.64v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667.0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667.0 01-88.021333-88.106666A88.064 88.064.0 11227.712 317.141333zm76.032 555.477334H151.68V384h152.064v488.618667zM948.266667.0h-872.704C33.792.0.0 33.024.0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667.0 948.138667.0h.128z"/></svg>
</a>
<a href=https://github.com/daveihart rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a>
<a href=https://davehart.co.uk/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2020 -
2021
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Dave
</span></span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
</body>
</html>