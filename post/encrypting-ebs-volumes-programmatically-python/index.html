<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Encrypting EBS volumes programmatically with python - Dave's DevOps blog</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes">
<meta name=MobileOptimized content="width">
<meta name=HandheldFriendly content="true">
<meta name=applicable-device content="pc,mobile">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=mobile-web-app-capable content="yes">
<meta name=author content="Dave">
<meta name=description content="Encrypting attached AWS EBS volume involves a number of steps. This article will show you how to encrypt your volumes using python.
Let&amp;rsquo;s set the scene, you have an environment hosting a number of AWS EC2 instances and now security have said, &amp;ldquo;Hey, these EBS volumes should be encrypted!&amp;rdquo; No argument from me. So how do we go about this programmatically.
 You can enable default volume encryption in the management console. Check this link out on how to do it.">
<meta name=keywords content="Hugo,theme,jane">
<meta name=generator content="Hugo 0.88.0">
<link rel=canonical href=https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css integrity="sha256-+ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media=screen crossorigin=anonymous>
<meta property="og:title" content="Encrypting EBS volumes programmatically with python">
<meta property="og:description" content="Encrypting attached AWS EBS volume involves a number of steps. This article will show you how to encrypt your volumes using python.
Let&rsquo;s set the scene, you have an environment hosting a number of AWS EC2 instances and now security have said, &ldquo;Hey, these EBS volumes should be encrypted!&rdquo; No argument from me. So how do we go about this programmatically.
 You can enable default volume encryption in the management console. Check this link out on how to do it.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-10-26T18:42:52+00:00">
<meta property="article:modified_time" content="2020-10-26T18:42:52+00:00">
<meta itemprop=name content="Encrypting EBS volumes programmatically with python">
<meta itemprop=description content="Encrypting attached AWS EBS volume involves a number of steps. This article will show you how to encrypt your volumes using python.
Let&rsquo;s set the scene, you have an environment hosting a number of AWS EC2 instances and now security have said, &ldquo;Hey, these EBS volumes should be encrypted!&rdquo; No argument from me. So how do we go about this programmatically.
 You can enable default volume encryption in the management console. Check this link out on how to do it."><meta itemprop=datePublished content="2020-10-26T18:42:52+00:00">
<meta itemprop=dateModified content="2020-10-26T18:42:52+00:00">
<meta itemprop=wordCount content="2980">
<meta itemprop=keywords content="AWS,AWS,Blog,ebs,encryption,GitHub,GitHub,python,python,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Encrypting EBS volumes programmatically with python">
<meta name=twitter:description content="Encrypting attached AWS EBS volume involves a number of steps. This article will show you how to encrypt your volumes using python.
Let&rsquo;s set the scene, you have an environment hosting a number of AWS EC2 instances and now security have said, &ldquo;Hey, these EBS volumes should be encrypted!&rdquo; No argument from me. So how do we go about this programmatically.
 You can enable default volume encryption in the management console. Check this link out on how to do it."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>Dave's blog</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/>Home</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/post/>Posts</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/tags/>Tags</a>
</li><li class=mobile-menu-item>
<a class=menu-item-link href=https://davehart.co.uk/about/>About</a>
</li>
</ul>
</nav>
<link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css>
<link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div>
<header id=header class="header container">
<div class=logo-wrapper>
<a href=/ class=logo>
Dave's blog
</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/>Home</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/post/>Posts</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/tags/>Tags</a>
</li>
<li class=menu-item>
<a class=menu-item-link href=https://davehart.co.uk/about/>About</a>
</li>
</ul>
</nav>
</header>
<div id=mobile-panel>
<main id=main class="main bg-llight">
<div class=content-wrapper>
<div id=content class="content container">
<article class="post bg-white">
<header class=post-header>
<h1 class=post-title>Encrypting EBS volumes programmatically with python</h1>
<div class=post-meta>
<time datetime=2020-10-26 class=post-time>
2020-10-26
</time>
<span class=more-meta> 2980 words </span>
<span class=more-meta> 14 min read </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>Table of Contents</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#a-word-on-reuse-of-code>A word on reuse of code</a></li>
<li><a href=#method>Method.</a></li>
<li><a href=#encryption-key>Encryption Key</a></li>
<li><a href=#process-flow>Process Flow</a>
<ul>
<li><a href=#flowchart---full>Flowchart - Full</a></li>
<li><a href=#flowchart---process-instances>Flowchart - Process Instances</a></li>
</ul>
</li>
<li><a href=#script>Script</a>
<ul>
<li><a href=#imports>Imports</a></li>
<li><a href=#variables>Variables</a></li>
</ul>
</li>
<li><a href=#functions>Functions</a>
<ul>
<li></li>
<li><a href=#assume_roles><strong>assume_roles</strong></a></li>
<li><a href=#get_instances><strong>get_instances</strong></a></li>
<li><a href=#process_instances>process_instances</a></li>
<li><a href=#get_status>get_status</a></li>
<li><a href=#shutdown_instance><strong>shutdown_instance</strong></a></li>
<li><a href=#shutdown_instance_wait><strong>shutdown_instance_wait</strong></a></li>
<li><a href=#detach_old_ebs>detach_old_ebs</a></li>
<li><a href=#create_ebs_wait>create_ebs_wait</a></li>
<li><a href=#snapshot_volumes>snapshot_volumes</a></li>
<li><a href=#create_snapshots_wait>create_snapshots_wait</a></li>
<li><a href=#snapshot_copy>snapshot_copy</a></li>
<li><a href=#create_ebs>create_ebs</a></li>
<li><a href=#attach_new_ebs>attach_new_ebs</a></li>
<li><a href=#set_delete_terminate>set_delete_terminate</a></li>
<li><a href=#delete_ebs>delete_ebs</a></li>
<li><a href=#start_instance>start_instance</a></li>
</ul>
</li>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p>Encrypting attached AWS EBS volume involves a number of steps. This article will show you how to encrypt your volumes using python.</p>
<p>Let&rsquo;s set the scene, you have an environment hosting a number of AWS EC2 instances and now security have said, &ldquo;Hey, these EBS volumes should be encrypted!&rdquo; No argument from me. So how do we go about this programmatically.</p>
<figure style="padding:.25rem;margin:2rem 0;background-color:#fff">
<img style=max-width:100%;width:auto;height:auto src=/post/encrypting-ebs-volumes-programmatically-python/info_hu90bf0207219454fdfafbb9c93dc105ef_65820_100x0_resize_q75_box.jpg width=100 height=100>
</figure>
<p><em><strong>You can enable default volume encryption in the management console. Check this <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html#encryption-by-default>link</a> out on how to do it. It was not always there hence the need for this process.</strong></em></p>
<h2 id=a-word-on-reuse-of-code>A word on reuse of code</h2>
<p>Just popping this in as if you looked at my article on <a href=/post/terraform-aws-and-wordpress-part-ii/>terminating EC2 instances by tag</a>, you will notice there is a fair bit of code reused here. A phrase I hear quite a lot over the years is &lsquo;let&rsquo;s not re-invent the wheel!&rsquo; So whilst this is fantastic advice, it sometimes takes longer finding where the wheel was last left! In my own development work I found that sometimes I could not find a snippet of code I once used. Thankfully these days we have things like online git repositories.</p>
<p>Getting back on topic&mldr;.</p>
<h2 id=method>Method.</h2>
<p>Unfortunately (at the time of writing) there is no easy method of changing an EBS volume from being unencrypted to encrypted. The process is along these lines</p>
<ol>
<li>Shutdown the instance (if running)</li>
<li>Create a snapshot (This will be unencrypted) of the EBS volume</li>
<li>Copy the snapshot and enable encryption of the copy</li>
<li>Create a new EBS volume from the encrypted snapshot</li>
<li>Detach the unencrypted EBS volume and attach the encrypted volume</li>
<li>Start the instance (if it was running)</li>
<li>Optional: Delete the unencrypted EBS volumes</li>
</ol>
<p>Hopefully you thought the same as me, you definitely do <strong>not</strong> want to be doing this manually!</p>
<h2 id=encryption-key>Encryption Key</h2>
<p>The example in this guide uses the AWS accounts default EBS encryption key. Should you for any reason want to share the encrypted volumes or snapshots with another account you cannot use the default key. It&rsquo;s the default key for the specific AWS account the key resides. You could create your own key and encrypt using that. The key you create can then be shared with other accounts.</p>
<p>The image below shows the default (AWS Managed) ebs encryption key.</p>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset src=https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/image-51.png>
</figure>
<h2 id=process-flow>Process Flow</h2>
<p>This is another one of those developed in bash for a <a href=https://www.gocd.org/>GoCD</a> pipeline scripts which I am again rewriting into Python.</p>
<p>We already have a feel for the steps involved listed in the method section above, let&rsquo;s take a look at the flowchart.</p>
<h3 id=flowchart---full>Flowchart - Full</h3>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ec2-terminate-flow_hu6c457011b29d1afcbd92f03dd0bfdc16_30884_480x0_resize_box_3.png 480w,
https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ec2-terminate-flow_hu6c457011b29d1afcbd92f03dd0bfdc16_30884_800x0_resize_box_3.png 800w," src=https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ec2-terminate-flow_hu6c457011b29d1afcbd92f03dd0bfdc16_30884_800x0_resize_box_3.png>
</figure>
<p>You will notice this is the same flow diagram used in the article <a href=/post/encrypting-ebs-volumes-programmatically-python/>Terminate EC2 instance by tag</a> . The flow will be the same, the &ldquo;Process Instances&rdquo; procedure is where are the interesting stuff with be done. Let&rsquo;s dive into that process</p>
<h3 id=flowchart---process-instances>Flowchart - Process Instances</h3>
<figure>
<img sizes="(min-width: 35em) 1200px, 100vw" srcset="https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ebs_encryption_detailed_flow_hu5adc0e2bd24870fac46764894226ac15_250459_480x0_resize_q75_box.jpeg 480w,
https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ebs_encryption_detailed_flow_hu5adc0e2bd24870fac46764894226ac15_250459_800x0_resize_q75_box.jpeg 800w,
https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ebs_encryption_detailed_flow_hu5adc0e2bd24870fac46764894226ac15_250459_1200x0_resize_q75_box.jpeg 1200w,
https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ebs_encryption_detailed_flow_hu5adc0e2bd24870fac46764894226ac15_250459_1500x0_resize_q75_box.jpeg 1500w," src=https://davehart.co.uk/post/encrypting-ebs-volumes-programmatically-python/ebs_encryption_detailed_flow_hu5adc0e2bd24870fac46764894226ac15_250459_800x0_resize_q75_box.jpeg>
</figure>
<p>As you can see, not a straightforward process.</p>
<h2 id=script>Script</h2>
<p>Similar to my previous scripts we break it down into functions. I will also include remarks to elaborate on some of the code. Not everyone will want or need the remarks so there will be a link at the end to the public github repository which is a lot cleaner.</p>
<h3 id=imports>Imports</h3>
<p>This first block of code is setting the scene by <strong><em>importing</em></strong> libraries or only parts of a library by using <strong><em>from</em></strong>.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=ch>#!/usr/bin/env python3.8</span>
<span class=kn>import</span> <span class=nn>botocore</span>
<span class=kn>import</span> <span class=nn>boto3</span>
<span class=kn>from</span> <span class=nn>boto3.session</span> <span class=kn>import</span> <span class=n>Session</span>
<span class=kn>from</span> <span class=nn>botocore.exceptions</span> <span class=kn>import</span> <span class=n>ClientError</span>
<span class=kn>import</span> <span class=nn>time</span>
<span class=kn>import</span> <span class=nn>os</span>
<span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
<span class=n>dt</span><span class=o>=</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span>
<span class=n>dtstr</span><span class=o>=</span><span class=n>dt</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=variables>Variables</h3>
<p>These are the variables we can use in any CD package</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>search_tag</span> <span class=o>=</span> <span class=s2>&#34;some_key_name&#34;</span> <span class=c1># Tag to search for instances</span>
<span class=n>search_value</span> <span class=o>=</span> <span class=s2>&#34;some_key_value&#34;</span>  <span class=c1>#value in tag to search for instances </span>
<span class=n>snap_prefix</span> <span class=o>=</span> <span class=n>dtstr</span><span class=o>+</span><span class=s2>&#34;-post_encryption-snapshot&#34;</span> <span class=c1>#snapshot description</span>
<span class=n>arole</span><span class=o>=</span><span class=s2>&#34;AddARoleHere&#34;</span> <span class=c1>#role to assume across accounts</span>
<span class=n>accounts</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;AWS Accounts Here&#39;</span><span class=p>,</span> <span class=s1>&#39;Another AWS Account here&#39;</span><span class=p>]</span> <span class=c1># list of accounts e.g [&#39;0000000000000&#39;,&#39;1111111111111&#39;,&#39;2222222222222222&#39;,&#39;333333333333333333&#39;]</span>
<span class=n>total_acc</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>accounts</span><span class=p>)</span>
<span class=n>region</span> <span class=o>=</span> <span class=s2>&#34;eu-west-2&#34;</span>
<span class=n>verbose</span> <span class=o>=</span> <span class=kc>True</span> <span class=c1>#False will suppress most of the output</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=functions>Functions</h2>
<h4 id=main><strong>Main</strong></h4>
<p>This is the function which ties it all together. It handles the calls to the other functions.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>ec2</span>
    <span class=k>global</span> <span class=n>instances</span>
    <span class=k>global</span> <span class=n>az2</span>
    <span class=k>global</span> <span class=n>Iid</span>
    <span class=k>global</span> <span class=n>inst</span>
    <span class=k>global</span> <span class=n>FailedIid</span>
    <span class=k>global</span> <span class=n>SuccessIid</span>
    <span class=n>processing_acc</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>FailedIid</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>SuccessIid</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;sts&#34;</span><span class=p>)</span>
    <span class=n>account_id</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_caller_identity</span><span class=p>()[</span><span class=s2>&#34;Account&#34;</span><span class=p>]</span>
    <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;script is executing in </span><span class=si>{</span><span class=n>account_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>acc</span> <span class=ow>in</span> <span class=n>accounts</span><span class=p>:</span>
        <span class=n>processing_acc</span> <span class=o>+=</span> <span class=mi>1</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Processing account : </span><span class=si>{</span><span class=n>processing_acc</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>acc</span> <span class=o>!=</span> <span class=n>account_id</span><span class=p>:</span>
            <span class=n>assume_roles</span><span class=p>(</span><span class=n>acc</span><span class=p>,</span><span class=n>accounts</span><span class=p>,</span><span class=n>arole</span><span class=p>)</span>
            <span class=n>ec2</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;ec2&#39;</span><span class=p>,</span><span class=n>aws_access_key_id</span><span class=o>=</span><span class=n>acc_key</span><span class=p>,</span><span class=n>aws_secret_access_key</span><span class=o>=</span><span class=n>sec_key</span><span class=p>,</span><span class=n>aws_session_token</span><span class=o>=</span><span class=n>sess_tok</span><span class=p>,</span><span class=n>region_name</span><span class=o>=</span><span class=s1>&#39;eu-west-1&#39;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Execution account, no assume required&#34;</span><span class=p>)</span>
            <span class=n>ec2</span><span class=o>=</span><span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;ec2&#39;</span><span class=p>)</span>
        <span class=n>instances</span> <span class=o>=</span> <span class=n>get_instances</span><span class=p>(</span><span class=n>processing_acc</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>inst</span> <span class=ow>in</span> <span class=n>instances</span><span class=p>:</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>az</span><span class=o>=</span><span class=n>inst</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;Placement&#34;</span><span class=p>)</span>
                <span class=n>az2</span><span class=o>=</span><span class=n>az</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;AvailabilityZone&#34;</span><span class=p>)</span>
                <span class=n>Iid</span> <span class=o>=</span> <span class=p>[]</span>
                <span class=n>Iid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>inst</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;InstanceId&#39;</span><span class=p>))</span>
                <span class=c1>#The for and first if can be removed, used to retrieve the name tag for verbose output</span>
                <span class=k>for</span> <span class=n>tags</span> <span class=ow>in</span> <span class=n>inst</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Tags&#39;</span><span class=p>):</span>
                    <span class=k>if</span> <span class=n>tags</span><span class=p>[</span><span class=s2>&#34;Key&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;Name&#39;</span><span class=p>:</span>
                        <span class=n>Iname</span> <span class=o>=</span> <span class=n>tags</span><span class=p>[</span><span class=s2>&#34;Value&#34;</span><span class=p>]</span>
                        <span class=n>process_instance</span><span class=p>(</span><span class=n>Iname</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-------------------------------------------------------------------------&#34;</span><span class=p>)</span>
            <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on main&#34;</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
                <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
                <span class=k>continue</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Errors encountered with these instances: </span><span class=si>{</span><span class=n>FailedIid</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Successfully processed these instances: </span><span class=si>{</span><span class=n>SuccessIid</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>main</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=assume_roles><strong>assume_roles</strong></h3>
<p>This is exactly the same as my reference script. Roles are good. Use roles! Bit like cake, I like cake!</p>
<p>If the AWS account being processed is not the AWS account the script is being executed from, you will need to assume a role defined in the target account. The role will have to have sufficient access to perform the necessary EC2 operations. In the source AWS account the instance, person or service performing the execution will need access to use the AWS Security Token Service (STS). AWS STS will grant temporary short lived credentials to perform the necessary activities. This is the recommended approach and removed the need to have credentials stored in code.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>assume_roles</span><span class=p>(</span><span class=n>acc</span><span class=p>,</span><span class=n>accounts</span><span class=p>,</span><span class=n>arole</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>acc_key</span>
    <span class=k>global</span> <span class=n>sec_key</span>
    <span class=k>global</span> <span class=n>sess_tok</span>
    <span class=k>global</span> <span class=n>client</span>
    <span class=n>sts_conn</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;sts&#39;</span><span class=p>)</span>
    <span class=n>tmp_arn</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>acc</span><span class=si>}</span><span class=s2>:role/</span><span class=si>{</span><span class=n>arole</span><span class=si>}</span><span class=s2>&#34;</span>
    <span class=n>response</span> <span class=o>=</span> <span class=n>sts_conn</span><span class=o>.</span><span class=n>assume_role</span><span class=p>(</span><span class=n>DurationSeconds</span><span class=o>=</span><span class=mi>900</span><span class=p>,</span><span class=n>RoleArn</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;arn:aws:iam::</span><span class=si>{</span><span class=n>tmp_arn</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>RoleSessionName</span><span class=o>=</span><span class=s1>&#39;Test&#39;</span><span class=p>)</span>
    <span class=n>acc_key</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Credentials&#39;</span><span class=p>][</span><span class=s1>&#39;AccessKeyId&#39;</span><span class=p>]</span>
    <span class=n>sec_key</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Credentials&#39;</span><span class=p>][</span><span class=s1>&#39;SecretAccessKey&#39;</span><span class=p>]</span>
    <span class=n>sess_tok</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;Credentials&#39;</span><span class=p>][</span><span class=s1>&#39;SessionToken&#39;</span><span class=p>]</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=get_instances><strong>get_instances</strong></h3>
<p>Another blatant re-use, handy this ;) Once you have worked out the AWS account security settings , you can start retrieving the EC2 instances for processing. The EC2 instances retrieved are filtered to only retrieve instances matching the <strong>search_tag</strong> and <strong>search_value</strong>. These are then added to a list for further processing.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>get_instances</span><span class=p>(</span><span class=n>process_acc</span><span class=p>,</span><span class=n>filters</span><span class=o>=</span><span class=p>[{</span><span class=s1>&#39;Name&#39;</span><span class=p>:</span> <span class=s1>&#39;tag:&#39;</span><span class=o>+</span><span class=n>search_tag</span><span class=p>,</span> <span class=s1>&#39;Values&#39;</span><span class=p>:</span> <span class=p>[</span><span class=n>search_value</span><span class=p>]}]):</span>
    <span class=n>reservations</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>reservations</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>describe_instances</span><span class=p>(</span>
            <span class=n>Filters</span><span class=o>=</span><span class=n>filters</span>
        <span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
    <span class=n>instances</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>reservation</span> <span class=ow>in</span> <span class=n>reservations</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Reservations&#39;</span><span class=p>,</span> <span class=p>[]):</span>
        <span class=k>for</span> <span class=n>instance</span> <span class=ow>in</span> <span class=n>reservation</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Instances&#39;</span><span class=p>,</span> <span class=p>[]):</span>
            <span class=n>instances</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>instance</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>instances</span> 
</code></pre></td></tr></table>
</div>
</div><h3 id=process_instances>process_instances</h3>
<p>This is the function which justified its own flowchart above. All of the processing of the EC2 instance is performed within this function and it makes all the calls to the functions which handle the snapshots, detaching, attaching etc.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>process_instance</span><span class=p>(</span><span class=n>Iname</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>volatt</span>
    <span class=k>global</span> <span class=n>volid</span>
    <span class=k>global</span> <span class=n>tags_list</span>
    <span class=k>global</span> <span class=n>Istate</span>
    <span class=k>global</span> <span class=n>IstateCode</span>
    <span class=n>processed_status</span> <span class=o>=</span> <span class=s2>&#34;no&#34;</span>    <span class=c1>#set a value to establish if the instance state has been retrieved</span>
    <span class=n>Istate</span> <span class=o>=</span> <span class=n>inst</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;State&#39;</span><span class=p>)</span>  
    <span class=n>IstateCode</span> <span class=o>=</span> <span class=n>Istate</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Code&#39;</span><span class=p>)</span>
    <span class=n>get_status</span><span class=p>(</span><span class=n>Iid</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Instance Name : </span><span class=si>{</span><span class=n>Iname</span><span class=si>}</span><span class=s2> ; Instance Id : </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> ; Instance state : </span><span class=si>{</span><span class=n>IstateCode</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Checking volumes attached to </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> for encryption settings&#34;</span><span class=p>)</span>
    <span class=n>vols</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>describe_volumes</span><span class=p>(</span>
        <span class=n>Filters</span><span class=o>=</span><span class=p>[</span>
        <span class=p>{</span>
            <span class=s1>&#39;Name&#39;</span><span class=p>:</span> <span class=s1>&#39;attachment.instance-id&#39;</span><span class=p>,</span>
            <span class=s1>&#39;Values&#39;</span><span class=p>:</span> <span class=p>[</span>
                <span class=nb>str</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span>
           <span class=p>],</span>
        <span class=p>},</span>
        <span class=p>],</span>
    <span class=p>)</span>
    <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=n>dev</span> <span class=ow>in</span> <span class=n>vols</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Volumes&#39;</span><span class=p>):</span>    <span class=c1>#Loop through each EBS volumes attached to the EC2 instance</span>
        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>+</span><span class=mi>1</span>   <span class=c1>#used to increment and show the volume number being processed</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;processing volume : </span><span class=si>{</span><span class=n>x</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>att</span> <span class=o>=</span> <span class=n>dev</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;Attachments&#34;</span><span class=p>)</span>   <span class=c1>#retrieve the attachment list in the volume json</span>
            <span class=n>encstatus</span> <span class=o>=</span> <span class=n>dev</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Encrypted&#39;</span><span class=p>)</span>   <span class=c1>#retrieve the encryption state</span>
            <span class=n>volid</span> <span class=o>=</span> <span class=n>dev</span><span class=o>.</span><span class=n>get</span> <span class=p>(</span><span class=s1>&#39;VolumeId&#39;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;volumeid :      </span><span class=si>{</span><span class=n>volid</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;attachment :    </span><span class=si>{</span><span class=n>att</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
            <span class=n>volatt</span> <span class=o>=</span> <span class=n>att</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Device&#39;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>encstatus</span> <span class=o>==</span> <span class=kc>False</span><span class=p>:</span>   <span class=c1>#its not encrypted so lets sort that out, its why we are here :)</span>
                <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Volume will need to be encrypted&#34;</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>initial_status</span> <span class=o>==</span> <span class=s2>&#34;running&#34;</span> <span class=ow>and</span> <span class=n>processed_status</span> <span class=o>==</span> <span class=s2>&#34;no&#34;</span><span class=p>:</span>   <span class=c1>#if the instance is running, shut it down. You only want to do this once and not iterate through it with each volume</span>
                    <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
                        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;shutting down </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
                    <span class=n>shutdown_instance</span><span class=p>(</span><span class=n>Iid</span><span class=p>)</span>  <span class=c1>#call the shutdown instance function</span>
                    <span class=n>processed_status</span> <span class=o>=</span> <span class=s2>&#34;yes&#34;</span>   <span class=c1>#set it as processed so we don&#39;t try shut it down again for the next volume</span>
                <span class=n>tags_list</span> <span class=o>=</span> <span class=n>dev</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;Tags&#39;</span><span class=p>,</span> <span class=p>[])</span>   <span class=c1>#We need the tags to add them to the new encrypted volume</span>
                <span class=n>moveon</span><span class=o>=</span><span class=s2>&#34;no&#34;</span>
                <span class=k>while</span> <span class=ow>not</span> <span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=n>FailedIid</span> <span class=ow>and</span> <span class=n>moveon</span> <span class=o>==</span> <span class=s2>&#34;no&#34;</span><span class=p>:</span>   <span class=c1>#step through this section until one of two things happen. The instance is added to the failure list or we set moveonto yes</span>
                    <span class=n>detach_old_ebs</span><span class=p>()</span>   <span class=c1>#function to detach the old EBS volume</span>
                    <span class=n>snapshot_volumes</span><span class=p>()</span>   <span class=c1>#function to create the unencrypted snapshot</span>
                    <span class=n>snapshot_copy</span><span class=p>()</span>   <span class=c1>#function to create an encrypted copy of the unencrypted snapshot and delete the unencrypted snapshot</span>
                    <span class=n>create_ebs</span><span class=p>()</span>   <span class=c1>#function to create an encrypted EBS volume from the encrypted snapshot</span>
                    <span class=n>attach_new_ebs</span><span class=p>()</span>   <span class=c1>#attach the new encrypted EBS volume</span>
                    <span class=n>set_delete_terminate</span><span class=p>()</span>   <span class=c1>#for good messure set the deleteonterminate flag to true</span>
                    <span class=n>delete_ebs</span><span class=p>()</span>   <span class=c1>#delete the old unencrypted ebs</span>
                    <span class=n>moveon</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>   <span class=c1>#flag to exit the while loop</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>volid</span><span class=si>}</span><span class=s2> is already encrypted&#34;</span><span class=p>)</span>
        <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>   <span class=c1>#capture and output any exceptions</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on check_volumes&#34;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
    <span class=k>if</span> <span class=n>initial_status</span> <span class=o>==</span> <span class=s2>&#34;running&#34;</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;starting instance </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=n>start_instance</span><span class=p>(</span><span class=n>Iid</span><span class=p>)</span>   <span class=c1>#if the instance was running when we started processing, start it back up</span>
    <span class=k>else</span><span class=p>:</span>   <span class=c1>#the EC2 instance was stopped when we started. We got this far so lets mark it as a success.</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=ow>in</span> <span class=n>FailedIid</span><span class=p>:</span>
            <span class=n>SuccessIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><p>The next few functions are all called by the preceding function so I will try keep them in a logical order starting of with retrieving the EC2 instances run state.</p>
<h3 id=get_status>get_status</h3>
<p>As this script will be stopping and starting instances you want to know what the starting state was. Why? you might ask. well let&rsquo;s say you were using the cloud in the correct manner, it&rsquo;s possible that the instances are already in a stopped state for cost saving purposes. You want to be able to leave them like that when you are finished. This function will work out the state based on the meta state codes. The variable names <em>initial_status</em> will be returned to the calling function.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>get_status</span><span class=p>(</span><span class=n>Iid</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>initial_status</span>
    <span class=k>if</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>16</span> <span class=ow>or</span> <span class=n>IstateCode</span> <span class=o>==</span><span class=mi>32</span> <span class=ow>or</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>64</span> <span class=ow>or</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>80</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>16</span><span class=p>:</span>
            <span class=n>initial_status</span> <span class=o>=</span> <span class=s2>&#34;running&#34;</span>
        <span class=k>elif</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>32</span> <span class=ow>or</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>64</span><span class=p>:</span>
            <span class=n>initial_status</span> <span class=o>=</span> <span class=s2>&#34;shutting_down&#34;</span>
        <span class=k>elif</span> <span class=n>IstateCode</span> <span class=o>==</span> <span class=mi>80</span><span class=p>:</span>
            <span class=n>initial_status</span> <span class=o>=</span> <span class=s2>&#34;stopped&#34;</span>
    <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Warning : Instance </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> is not running, stopping or stopped. Please perform a manual check&#34;</span><span class=p>)</span>
            <span class=n>initial_status</span> <span class=o>=</span> <span class=s2>&#34;not_sure&#34;</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
    <span class=k>return</span> <span class=n>initial_status</span> <span class=c1>#Capture and return the status to the calling function</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=shutdown_instance><strong>shutdown_instance</strong></h3>
<p>Shutdown the EC2 instance being processed.</p>
<figure style="padding:.25rem;margin:2rem 0;background-color:#fff">
<img style=max-width:100%;width:auto;height:auto src=/post/encrypting-ebs-volumes-programmatically-python/info_hu90bf0207219454fdfafbb9c93dc105ef_65820_100x0_resize_q75_box.jpg width=100 height=100>
</figure>
<p>You might notice a number of try and except statements in the functions throughout this example. Try something, if it fails, capture and output the error. All part of improving my code and learning something new. Good link <a href=https://docs.python.org/3/tutorial/errors.html>here</a> on this very subject.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>shutdown_instance</span><span class=p>(</span><span class=n>Iid</span><span class=p>):</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>ec2</span><span class=o>.</span><span class=n>stop_instances</span><span class=p>(</span><span class=n>InstanceIds</span><span class=o>=</span><span class=n>Iid</span><span class=p>)</span>
        <span class=n>shutdown_instance_wait</span><span class=p>(</span><span class=n>Iid</span><span class=p>,</span><span class=n>initial_status</span><span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on shutdown_instance&#34;</span><span class=p>)</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=shutdown_instance_wait><strong>shutdown_instance_wait</strong></h3>
<p>call the waiter to ensure you do not try to detach or attach disks whilst the EC2 instance is running. That will not work!</p>
<p>e.g. the _class_EC2.Waiter.InstanceTerminated polls<a href=https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.Client.describe_instances>EC2.Client.describe_instances()</a>every 15 seconds until a successful state is reached. An error is returned after 40 failed checks (10 minutes if you were working it out).</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>shutdown_instance_wait</span><span class=p>(</span><span class=n>Iid</span><span class=p>):</span>
    <span class=n>shutdown_instance_waiter</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>get_waiter</span><span class=p>(</span><span class=s1>&#39;instance_stopped&#39;</span><span class=p>)</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>shutdown_instance_waiter</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>InstanceIds</span><span class=o>=</span><span class=n>Iid</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Instance </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> has shutdown successfully&#34;</span><span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>WaiterError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=k>if</span> <span class=s2>&#34;Max attempts exceeded&#34;</span> <span class=ow>in</span> <span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on shutdown_instance_wait&#34;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Instance </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> did not shutdown in 600 seconds&#34;</span><span class=p>)</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on shutdown_instance_wait_else&#34;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
    <span class=k>return</span> <span class=n>initial_status</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=detach_old_ebs>detach_old_ebs</h3>
<p>Now that the instance is safely stopped we can detach the EBS volume being processed.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>detach_old_ebs</span><span class=p>():</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=k>global</span> <span class=n>ebs_wait</span>
        <span class=n>detach_ebs</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>detach_volume</span><span class=p>(</span>
        <span class=n>Device</span><span class=o>=</span><span class=n>volatt</span><span class=p>,</span>
        <span class=n>InstanceId</span><span class=o>=</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
        <span class=n>VolumeId</span><span class=o>=</span><span class=n>volid</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Waiting for volume </span><span class=si>{</span><span class=n>volid</span><span class=si>}</span><span class=s2> to be detached&#34;</span><span class=p>)</span>
        <span class=n>ebs_wait</span> <span class=o>=</span> <span class=n>volid</span>
        <span class=n>create_ebs_wait</span><span class=p>()</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on detach_old_ebs&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=create_ebs_wait>create_ebs_wait</h3>
<p>We need to ensure the volume is detached before we proceed with either trying to attach another volume to its device attachment or before trying to terminate it. This waiter turned into a bit of a pain. The proceeding steps would not always work as they were seeing the original EBS as still attached. In the end the introduction of a 5 second timer resolved the issue which implies the waiter is not that reliable for the &ldquo;volume_available&rdquo; wait! No tip for him! (Yes, I was dying to say that :) ). We will use this waiter again when we attach the new EBS volume</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>create_ebs_wait</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>ebs_check</span>
    <span class=n>ebs_check</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>ebs_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ebs_wait</span><span class=p>)</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>create_ebs_available_waiter</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>get_waiter</span><span class=p>(</span><span class=s1>&#39;volume_available&#39;</span><span class=p>)</span>
        <span class=n>create_ebs_available_waiter</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>VolumeIds</span><span class=o>=</span><span class=n>ebs_check</span><span class=p>)</span>  
        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>   <span class=c1>#Not impressed that I needed to use this. googling proved I was not alone in this</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>WaiterError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=k>if</span> <span class=s2>&#34;Max attempts exceeded&#34;</span> <span class=ow>in</span> <span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Volume </span><span class=si>{</span><span class=n>enc_ebs_id</span><span class=si>}</span><span class=s2> was not available in the max wait time&#34;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on create_ebs_wait&#34;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>    
</code></pre></td></tr></table>
</div>
</div><h3 id=snapshot_volumes>snapshot_volumes</h3>
<p>Create an unencrypted snapshot of the now detached unencrypted EBS volume. Add the tags we retrieved from the EBS volume to the snapshot.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>snapshot_volumes</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>snap_shot</span>
    <span class=k>global</span> <span class=n>unenc_snapshot</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>snap_shot</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>create_snapshot</span><span class=p>(</span>
            <span class=n>VolumeId</span><span class=o>=</span><span class=n>volid</span><span class=p>,</span>
            <span class=n>Description</span><span class=o>=</span><span class=n>snap_prefix</span><span class=p>,</span>
            <span class=n>TagSpecifications</span><span class=o>=</span><span class=p>[</span>
                <span class=p>{</span>
                <span class=s1>&#39;ResourceType&#39;</span> <span class=p>:</span> <span class=s1>&#39;snapshot&#39;</span><span class=p>,</span>
                <span class=s1>&#39;Tags&#39;</span><span class=p>:</span> <span class=n>tags_list</span><span class=p>,</span>      
                <span class=p>}</span>
            <span class=p>],</span>
        <span class=p>)</span>
        <span class=n>create_snapshots_wait</span><span class=p>(</span><span class=n>snap_shot</span><span class=p>)</span>
        <span class=n>unenc_snapshot</span> <span class=o>=</span> <span class=n>snap_shot</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;SnapshotId&#39;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unencrypted snapshot : </span><span class=si>{</span><span class=n>unenc_snapshot</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on snapshot_volumes&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=create_snapshots_wait>create_snapshots_wait</h3>
<p>This function will be called by the snapshot_volumes function and also the snapshot_copy function. Both of these rely upon the same waiter, snapshot_completed</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>create_snapshots_wait</span><span class=p>(</span><span class=n>snap_shot</span><span class=p>):</span>
    <span class=k>global</span> <span class=n>snap_check</span>
    <span class=n>snap_check</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>snap_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>snap_shot</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;SnapshotId&#39;</span><span class=p>))</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>create_snapshot_waiter</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>get_waiter</span><span class=p>(</span><span class=s1>&#39;snapshot_completed&#39;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Waiting for </span><span class=si>{</span><span class=n>snap_check</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=n>create_snapshot_waiter</span><span class=o>.</span><span class=n>wait</span><span class=p>(</span><span class=n>SnapshotIds</span><span class=o>=</span><span class=n>snap_check</span><span class=p>)</span>  
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>WaiterError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=k>if</span> <span class=s2>&#34;Max attempts exceeded&#34;</span> <span class=ow>in</span> <span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on create_snapshots_wait&#34;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Instance </span><span class=si>{</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> did not shutdown in 600 seconds&#34;</span><span class=p>)</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on create_snapshots_wait_else&#34;</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
            <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=snapshot_copy>snapshot_copy</h3>
<p>Now we make use of the unencrypted snapshot and create a copy turning on encryption. Again we make use of the original EBS volume tags. We call the preceding wait function again.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>snapshot_copy</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>enc_snapshot</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>snap_shot</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>copy_snapshot</span><span class=p>(</span>
        <span class=n>Description</span><span class=o>=</span><span class=s2>&#34;encrypted-&#34;</span><span class=o>+</span><span class=n>snap_prefix</span><span class=p>,</span>
        <span class=n>TagSpecifications</span><span class=o>=</span><span class=p>[</span>
                <span class=p>{</span>
                <span class=s1>&#39;ResourceType&#39;</span> <span class=p>:</span> <span class=s1>&#39;snapshot&#39;</span><span class=p>,</span>
                <span class=s1>&#39;Tags&#39;</span><span class=p>:</span> <span class=n>tags_list</span><span class=p>,</span>      
                <span class=p>}</span>
            <span class=p>],</span>  
        <span class=n>Encrypted</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
        <span class=n>SourceRegion</span><span class=o>=</span><span class=n>region</span><span class=p>,</span>
        <span class=n>SourceSnapshotId</span><span class=o>=</span><span class=n>snap_check</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
        <span class=p>)</span>
        <span class=n>enc_snapshot</span> <span class=o>=</span> <span class=n>snap_shot</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;SnapshotId&#39;</span><span class=p>)</span>
        <span class=n>create_snapshots_wait</span><span class=p>(</span><span class=n>snap_shot</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;encrypted snapshot : </span><span class=si>{</span><span class=n>enc_snapshot</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on snapshot_copy&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
    <span class=n>ec2</span><span class=o>.</span><span class=n>delete_snapshot</span><span class=p>(</span><span class=n>SnapshotId</span><span class=o>=</span><span class=n>unenc_snapshot</span><span class=p>,</span>
    <span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=create_ebs>create_ebs</h3>
<p>We now make use of the encrypted snapshot to make an encrypted EBS volume</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>create_ebs</span><span class=p>():</span>
    <span class=k>global</span> <span class=n>enc_ebs_id</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>enc_ebs</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>create_volume</span><span class=p>(</span>
        <span class=n>AvailabilityZone</span><span class=o>=</span><span class=n>az2</span><span class=p>,</span>
        <span class=n>Encrypted</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
        <span class=n>SnapshotId</span><span class=o>=</span><span class=n>enc_snapshot</span><span class=p>,</span>
        <span class=n>TagSpecifications</span><span class=o>=</span><span class=p>[</span>
                <span class=p>{</span>
                <span class=s1>&#39;ResourceType&#39;</span> <span class=p>:</span> <span class=s1>&#39;volume&#39;</span><span class=p>,</span>
                <span class=s1>&#39;Tags&#39;</span><span class=p>:</span> <span class=n>tags_list</span><span class=p>,</span>      
                <span class=p>}</span>
            <span class=p>],</span>
        <span class=p>)</span>
        <span class=n>enc_ebs_id</span> <span class=o>=</span> <span class=n>enc_ebs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;VolumeId&#39;</span><span class=p>)</span>
        <span class=n>ebs_wait</span> <span class=o>=</span> <span class=n>enc_ebs_id</span>
        <span class=n>create_ebs_wait</span><span class=p>()</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on create_ebs&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><p>We call the previously describe waiter we used for the EBS volume detach function</p>
<h3 id=attach_new_ebs>attach_new_ebs</h3>
<p>We are as sure as we can be (without adding a further check) that the attachment is now free so we can attach the new EBS volume</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>attach_new_ebs</span><span class=p>():</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Attaching volume </span><span class=si>{</span><span class=n>enc_ebs_id</span><span class=si>}</span><span class=s2> to </span><span class=si>{</span><span class=n>volatt</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
        <span class=n>attach_ebs</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>attach_volume</span><span class=p>(</span>
        <span class=n>Device</span><span class=o>=</span><span class=n>volatt</span><span class=p>,</span>
        <span class=n>InstanceId</span><span class=o>=</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>
        <span class=n>VolumeId</span><span class=o>=</span><span class=n>enc_ebs_id</span><span class=p>,</span>
        <span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on attach_new_ebs&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=set_delete_terminate>set_delete_terminate</h3>
<p>Ensures that the EBS volumes have the value deleteonetermination set to true. Without this you can end up with a lot of orphaned EBS volumes. It&rsquo;s not required for volume encryption just some housekeeping.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>set_delete_terminate</span><span class=p>():</span>
    <span class=k>if</span> <span class=n>verbose</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;deleteontermination check : </span><span class=si>{</span><span class=n>enc_ebs_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
    <span class=n>delonterm</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>modify_instance_attribute</span><span class=p>(</span>
    <span class=n>Attribute</span><span class=o>=</span><span class=s1>&#39;blockDeviceMapping&#39;</span><span class=p>,</span>
    <span class=n>BlockDeviceMappings</span><span class=o>=</span><span class=p>[</span>
    <span class=p>{</span>
    <span class=s1>&#39;DeviceName&#39;</span><span class=p>:</span> <span class=n>volatt</span><span class=p>,</span>
    <span class=s1>&#39;Ebs&#39;</span><span class=p>:</span> <span class=p>{</span>
    <span class=s1>&#39;DeleteOnTermination&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>}}],</span>
    <span class=n>InstanceId</span><span class=o>=</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=delete_ebs>delete_ebs</h3>
<p>This one depends on how much confidence you have. It will terminate the original unencrypted EBS volume&mldr;gulp (You should already have a backup / snapshot lifecycle in place to give you that warm feeling)</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>delete_ebs</span><span class=p>():</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>delete_ebs</span> <span class=o>=</span> <span class=n>ec2</span><span class=o>.</span><span class=n>delete_volume</span><span class=p>(</span>
            <span class=n>VolumeId</span><span class=o>=</span><span class=n>volid</span>
        <span class=p>)</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on delete_ebs&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=start_instance>start_instance</h3>
<p>And finally you want to start the instance back up if this was the original state.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>start_instance</span><span class=p>(</span><span class=n>Iid</span><span class=p>):</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>ec2</span><span class=o>.</span><span class=n>start_instances</span><span class=p>(</span><span class=n>InstanceIds</span><span class=o>=</span><span class=n>Iid</span><span class=p>)</span>
        <span class=n>SuccessIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
    <span class=k>except</span> <span class=n>botocore</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ClientError</span> <span class=k>as</span> <span class=n>er</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;error on start_instance&#34;</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>er</span><span class=o>.</span><span class=n>response</span><span class=p>[</span><span class=s1>&#39;Error&#39;</span><span class=p>][</span><span class=s1>&#39;Message&#39;</span><span class=p>])</span>
        <span class=n>FailedIid</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Iid</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=conclusion>Conclusion</h2>
<p>There we go, a python script which retrieves AWS EC2 instances across multiple AWS Accounts assuming roles where required. The instances are checked for unencrypted EBS volumes, if found they are processed to provide the end result of encrypted EBS volumes.</p>
<p>The script will output a list of successful and failed instance id&rsquo;s for checking.</p>
<p>As usual, <a href=https://github.com/daveihart/python-aws-ebs_encryption_public>here</a> is a link to my GitHub repo containing the source code. Feel free to ask any question or suggest any improvements.</p>
<p>Till next time.</p>
<p>Disclaimer: This script will terminate EBS volumes. Use at your own risk!</p>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=https://davehart.co.uk/tags/aws/>AWS</a>
<a href=https://davehart.co.uk/tags/aws/>AWS</a>
<a href=https://davehart.co.uk/tags/blog/>Blog</a>
<a href=https://davehart.co.uk/tags/ebs/>ebs</a>
<a href=https://davehart.co.uk/tags/encryption/>encryption</a>
<a href=https://davehart.co.uk/tags/github/>GitHub</a>
<a href=https://davehart.co.uk/tags/github/>GitHub</a>
<a href=https://davehart.co.uk/tags/python/>python</a>
<a href=https://davehart.co.uk/tags/python/>python</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/automation-apache-and-route-53/>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i>
<span class="prev-text nav-default">Automation: Apache and Route 53</span>
<span class="prev-text nav-mobile">Prev</span>
</a>
<a class=next href=/post/backups-monitoring-and-maintenance-keep-that-blog-alive/>
<span class="next-text nav-default">Backups, monitoring and maintenance. Keep that blog alive!</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg>
</i>
</a>
</nav>
</footer>
</article>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=icon-links>
<a href=https://twitter.com/daveihart rel="me noopener" class=iconfont title=twitter target=_blank><svg class="icon" viewBox="0 0 1264 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M1229.8616 18.043658s-117.852626 63.135335-164.151872 67.344358C960.484169-78.763856 560.627046-7.210476 627.971403 308.466201 278.622548 312.675223 89.216542 47.506814 89.216542 47.506814S-28.636084 236.91282 164.978944 392.646647C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042 50.5082679999998-16.83609 134.688715-143.10676 134.688715-143.10676s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"/></svg>
</a>
<a href=https://www.linkedin.com/in/dave-hart/ rel="me noopener" class=iconfont title=linkedin target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="33" height="33"><path d="M872.405333 872.618667H720.768V635.008c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333.0-91.136 61.653333-91.136 125.397334v241.792H398.976V384H544.64v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667.0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667.0 01-88.021333-88.106666A88.064 88.064.0 11227.712 317.141333zm76.032 555.477334H151.68V384h152.064v488.618667zM948.266667.0h-872.704C33.792.0.0 33.024.0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667.0 948.138667.0h.128z"/></svg>
</a>
<a href=https://github.com/daveihart rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a>
<a href=https://davehart.co.uk/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg>
</a>
</div>
<div class=copyright>
<span class=power-by>
Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span>
<span class=division>|</span>
<span class=theme-info>
Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span>
<span class=copyright-year>
&copy;
2020 -
2021
<span class=heart>
<i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i>
</span><span class=author>
Dave
</span></span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg>
</i>
</div>
</div>
<script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script>
<script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script>
<script type=text/javascript src=/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/load-photoswipe.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script>
<script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script>
</body>
</html>